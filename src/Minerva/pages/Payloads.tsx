import React, { useState, useEffect, useRef } from 'react';
import { createPortal } from 'react-dom';
import { useQuery, useMutation, useLazyQuery, useSubscription, gql, useReactiveVar } from '@apollo/client';
import { motion, AnimatePresence } from 'framer-motion';
import { 
    Box, 
    Download, 
    Trash2, 
    RotateCcw, 
    Eye, 
    EyeOff, 
    Bell, 
    BellOff, 
    ChevronDown, 
    Plus, 
    Upload, 
    Settings,
    Info,
    AlertTriangle,
    CheckCircle,
    XCircle,
    RefreshCw,
    MoreVertical,
    FileText,
    Shield,
    Layers,
    Copy,
    Package,
    Tag as TagIcon,
    Clock,
    Terminal,
    Loader2,
    Server,
    Ban,
    List,
    Wrench,
    Link,
    ChevronRight,
    ChevronLeft,
    Monitor,
    Command,
    Smartphone,
    Globe,
    Check,
    Disc,
    Search,
    Radio,
    Sliders,
    Edit3,
    MessageSquare,
    AlertCircle,
    Fingerprint,
    FlaskConical,
    PhoneCall,
    ArrowLeftRight,
    X,
    Play
} from 'lucide-react';
import { useNavigate, useSearchParams } from 'react-router-dom';
import { Sidebar } from '../components/Sidebar';
import { cn, b64DecodeUnicode, b64EncodeUnicode } from '../lib/utils';
import { CyberDropdown } from '../components/CyberDropdown';
import { snackActions } from '../../Archive/components/utilities/Snackbar';
import { getSkewedNow, toLocalTime } from '../../Archive/components/utilities/Time';
import { meState } from '../../cache';
import { useAppStore } from '../store';
import { CreateWrapperWizard } from './CreateWrapper';
import { useBattleMode } from '../context/BattleModeContext';

// Animation duration helper - 2x speed in combat mode
const getAnimDuration = (baseDuration: number, isCombat: boolean) => isCombat ? baseDuration / 2 : baseDuration;

// ============================================
// GraphQL Fragments, Queries & Mutations
// ============================================
const payloadFragment = gql`
fragment payloadData on payload {
  build_message
  build_phase
  build_stderr
  callback_alert
  callback_allowed
  id
  uuid
  description
  deleted
  auto_generated
  timestamp
  payload_type_semver
  os
  creation_time
  payloadtype {
    id
    name
    semver
  }
  operator {
    id
    username
  }
  payload_build_steps(order_by: {step_number: asc}) {
    step_name
    step_number
    step_success
    step_skip
    start_time
    end_time
    step_stdout
    step_stderr
    id
  }
  buildparameterinstances {
    id
    value
    buildparameter {
      id
      name
      description
      parameter_type
    }
  }
  payloadcommands {
    id
    command {
      id
      cmd
    }
  }
  tags {
    tagtype {
        name
        color
        id
      }
    id
  }
  filemetum {
    agent_file_id
    filename_text
    id
    md5
    sha1
    size
    tags {
        tagtype {
            name
            color
            id
          }
        id
    }
  }
  payloadc2profiles {
    c2profile {
      running
      name
      is_p2p
      container_running
    }
  }
}
`;

const SUB_Payloads = gql`
${payloadFragment}
subscription SubPayloadsQuery($now: timestamp!) {
  payload_stream(batch_size: 10, cursor: {initial_value: {timestamp: $now}, ordering: ASC}) {
    ...payloadData
  }
}
`;

const PayloadsQuery = gql`
${payloadFragment}
query PayloadsQuery($offset: Int!, $limit: Int!, $showDeleted: Boolean!, $showAutogenerated: Boolean!) {
  payload(order_by: {id: desc}, offset: $offset, limit: $limit, where: {auto_generated: {_eq: $showAutogenerated}, deleted: {_eq: $showDeleted}}) {
    ...payloadData
  }
  payload_aggregate(where: {auto_generated: {_eq: $showAutogenerated}, deleted: {_eq: $showDeleted}}) {
    aggregate {
      count
    }
  }
}
`;

const payloadsDelete = gql`
mutation PayloadsDeletePayloadMutation($payload_uuid: String!) {
  updatePayload(payload_uuid: $payload_uuid, deleted: true) {
      status
      error
      id
      deleted
  }
}
`;

const payloadsCallbackAlert = gql`
mutation PayloadsCallbackAlertMutation($payload_uuid: String!, $callback_alert: Boolean!) {
  updatePayload(callback_alert: $callback_alert, payload_uuid: $payload_uuid) {
    id
    callback_alert
    status
    error
  }
}
`;

const restorePayloadMutation = gql`
mutation RestorePayloadToUndeleted($payload_uuid: String!){
  updatePayload(deleted: false, payload_uuid: $payload_uuid) {
    id
    deleted
    status
    error
  }
}
`;

const payloadsCallbackAllowed = gql`
mutation PayloadsCallbackAllowedMutation($payload_uuid: String!, $callback_allowed: Boolean!) {
  updatePayload(callback_allowed: $callback_allowed, payload_uuid: $payload_uuid) {
    id
    callback_allowed
    status
    error
  }
}
`;

const rebuildPayloadMutation = gql`
mutation triggerRebuildMutation($uuid: String!) {
  rebuild_payload(uuid: $uuid) {
      status
      error
      uuid
  }
}
`;

const exportPayloadConfigQuery = gql`
query exportPayloadConfigQuery($uuid: String!) {
  exportPayloadConfig(uuid: $uuid) {
      status
      error 
      config 
  }
}
`;

// Update filename mutation
const updateFilenameMutation = gql`
mutation updateFilename($file_id: Int!, $filename: bytea!) {
  update_filemeta_by_pk(pk_columns: {id: $file_id}, _set: {filename: $filename}) {
    filename_text
    id
  }
}
`;

// Update description mutation  
const updatePayloadDescriptionMutation = gql`
mutation updatePayloadDescription($payload_uuid: String!, $description: String) {
  updatePayload(payload_uuid: $payload_uuid, description: $description) {
    description
    id
  }
}
`;

// Generate redirect rules query
const generateRedirectRulesQuery = gql`
query generateRedirectRules($uuid: String!) {
  redirectRules(uuid: $uuid) {
    status
    error
    output
  }
}
`;

// Check agent configuration query
const checkAgentConfigQuery = gql`
query checkAgentConfig($uuid: String!) {
  config_check(uuid: $uuid) {
    status
    error
    output
  }
}
`;

// Generate IOCs query
const generateIOCsQuery = gql`
query generateIOCs($uuid: String!) {
  getIOC(uuid: $uuid) {
    status
    error
    iocs
  }
}
`;

// Generate sample message query
const generateSampleMessageQuery = gql`
query generateSampleMessage($uuid: String!) {
  getSampleMessage(uuid: $uuid) {
    status
    error
    message
  }
}
`;

// Create fake callback mutation
const createFakeCallbackMutation = gql`
mutation createFakeCallback($payloadUUID: String!) {
    createFakeCallback(payloadUUID: $payloadUUID){
        status
        error
    }
}
`;

// ============================================
// Types
// ============================================
interface PayloadTag {
    id: number;
    tagtype: {
        name: string;
        color: string;
        id: number;
    };
}

interface PayloadBuildStep {
    id: number;
    step_name: string;
    step_number: number;
    step_success: boolean | null;
    step_skip: boolean;
    start_time: string | null;
    end_time: string | null;
    step_stdout: string;
    step_stderr: string;
}

interface Payload {
    id: number;
    uuid: string;
    description: string;
    deleted: boolean;
    auto_generated: boolean;
    timestamp: string;
    build_message: string;
    build_phase: string;
    build_stderr: string;
    callback_alert: boolean;
    callback_allowed: boolean;
    payload_type_semver: string;
    payloadtype: {
        id: number;
        name: string;
        semver: string;
    };
    payload_build_steps: PayloadBuildStep[];
    tags: PayloadTag[];
    filemetum: {
        agent_file_id: string;
        filename_text: string;
        id: number;
        tags: PayloadTag[];
    } | null;
    payloadc2profiles: {
        c2profile: {
            running: boolean;
            name: string;
            is_p2p: boolean;
            container_running: boolean;
        };
    }[];
}

// ============================================
// Helper Components
// ============================================

// Build Status Badge - Shows colored status with icon
const BuildStatusBadge = ({ phase }: { phase: string }) => {
    const getConfig = () => {
        switch (phase) {
            case 'success':
                return { 
                    icon: CheckCircle, 
                    color: 'text-green-400', 
                    bg: 'bg-green-400/10', 
                    border: 'border-green-400/30',
                    label: 'SUCCESS' 
                };
            case 'building':
                return { 
                    icon: Loader2, 
                    color: 'text-yellow-400', 
                    bg: 'bg-yellow-400/10', 
                    border: 'border-yellow-400/30',
                    label: 'BUILDING',
                    animate: true 
                };
            case 'error':
                return { 
                    icon: XCircle, 
                    color: 'text-red-400', 
                    bg: 'bg-red-400/10', 
                    border: 'border-red-400/30',
                    label: 'ERROR' 
                };
            default:
                return { 
                    icon: Clock, 
                    color: 'text-yellow-400', 
                    bg: 'bg-yellow-400/10', 
                    border: 'border-yellow-400/30',
                    label: phase?.toUpperCase() || 'PENDING' 
                };
        }
    };

    const config = getConfig();
    const Icon = config.icon;

    return (
        <span className={cn(
            "inline-flex items-center gap-2 px-2.5 py-1 rounded text-xs font-mono border",
            config.color, config.bg, config.border
        )}>
            <Icon size={14} className={config.animate ? "animate-spin" : ""} />
            {config.label}
        </span>
    );
};

// C2 Profile Status Indicator
const C2StatusIndicator = ({ c2profiles }: { c2profiles: Payload['payloadc2profiles'] }) => {
    if (!c2profiles || c2profiles.length === 0) {
        return <span className="text-gray-500 text-xs font-mono">—</span>;
    }

    return (
        <div className="flex flex-wrap gap-1.5">
            {c2profiles.map((p, idx) => {
                const isRunning = p.c2profile.running && p.c2profile.container_running;
                return (
                    <span 
                        key={idx}
                        className={cn(
                            "inline-flex items-center gap-1.5 px-2 py-0.5 rounded text-xs font-mono border",
                            isRunning 
                                ? "text-green-400 bg-green-400/10 border-green-400/30" 
                                : "text-red-400 bg-red-400/10 border-red-400/30",
                            p.c2profile.is_p2p && "border-dashed"
                        )}
                    >
                        <span className={cn(
                            "w-1.5 h-1.5 rounded-full",
                            isRunning ? "bg-green-400" : "bg-red-400"
                        )} />
                        {p.c2profile.name}
                        {p.c2profile.is_p2p && " (P2P)"}
                    </span>
                );
            })}
        </div>
    );
};

// Tags Display Component
const TagsDisplay = ({ tags }: { tags: PayloadTag[] }) => {
    if (!tags || tags.length === 0) return <span className="text-gray-500 text-xs font-mono">—</span>;

    return (
        <div className="flex flex-wrap gap-1">
            {tags.map((tag) => (
                <span 
                    key={tag.id}
                    className="inline-flex items-center gap-1 px-1.5 py-0.5 rounded text-xs font-mono"
                    style={{ 
                        backgroundColor: `${tag.tagtype.color}20`, 
                        color: tag.tagtype.color,
                        border: `1px solid ${tag.tagtype.color}40`
                    }}
                >
                    <TagIcon size={10} />
                    {tag.tagtype.name}
                </span>
            ))}
        </div>
    );
};

// Build Progress Steps
const BuildProgressSteps = ({ steps, buildPhase, isCombat = false }: { steps: PayloadBuildStep[]; buildPhase?: string; isCombat?: boolean }) => {
    if (!steps || steps.length === 0) return null;

    const completedSteps = steps.filter(s => s.step_success === true || s.step_skip).length;
    const totalSteps = steps.length;
    const progress = (completedSteps / totalSteps) * 100;
    const hasStepError = steps.some(s => s.step_success === false && !s.step_skip);
    const isBuilding = buildPhase === 'building';
    const isError = buildPhase === 'error' || hasStepError;

    // Color logic: error = red, building = yellow, complete = green
    const getBarColor = () => {
        if (isError) return "bg-red-500";
        if (isBuilding) return "bg-yellow-400";
        if (progress === 100) return "bg-green-400";
        return "bg-yellow-400"; // default to yellow for in-progress
    };

    return (
        <div className="flex items-center gap-2 mt-1.5">
            <div className="flex-1 h-1 bg-gray-700 rounded-full overflow-hidden">
                <motion.div 
                    className={cn("h-full rounded-full", getBarColor())}
                    initial={{ width: 0 }}
                    animate={{ width: `${progress}%` }}
                    transition={{ duration: getAnimDuration(0.3, isCombat) }}
                />
            </div>
            <span className="text-xs text-gray-500 font-mono">{completedSteps}/{totalSteps}</span>
        </div>
    );
};

// ============================================
// Payload Row Component
// ============================================
interface PayloadRowProps {
    payload: Payload;
    onDelete: (uuid: string) => void;
    onRestore: (uuid: string) => void;
    onToggleAlert: (uuid: string, alert: boolean) => void;
    onToggleAllowed: (uuid: string, allowed: boolean) => void;
    onRebuild: (uuid: string) => void;
    onExportConfig: (uuid: string) => void;
    showDeleted: boolean;
    isCombat?: boolean;
}

// Dialog Component for viewing/editing text content
const PayloadDialog: React.FC<{
    open: boolean;
    onClose: () => void;
    title: string;
    content: string;
    loading?: boolean;
    error?: string;
    editable?: boolean;
    onSave?: (value: string) => void;
}> = ({ open, onClose, title, content, loading, error, editable, onSave }) => {
    const [editValue, setEditValue] = useState(content);
    
    useEffect(() => {
        setEditValue(content);
    }, [content]);
    
    if (!open) return null;
    
    return createPortal(
        <div className="fixed inset-0 z-[9999] flex items-center justify-center bg-black/70 backdrop-blur-sm">
            <motion.div 
                initial={{ opacity: 0, scale: 0.95 }}
                animate={{ opacity: 1, scale: 1 }}
                exit={{ opacity: 0, scale: 0.95 }}
                className="bg-void border border-signal/30 rounded-lg shadow-2xl w-full max-w-2xl max-h-[80vh] overflow-hidden"
            >
                <div className="bg-signal/10 p-4 border-b border-signal/30 flex items-center justify-between">
                    <h3 className="font-mono font-bold text-signal tracking-widest">{title}</h3>
                    <button onClick={onClose} className="text-ghost hover:text-signal transition-colors">
                        <X size={20} />
                    </button>
                </div>
                <div className="p-4 overflow-y-auto max-h-[60vh] cyber-scrollbar">
                    {loading ? (
                        <div className="flex items-center justify-center py-8">
                            <Loader2 className="animate-spin text-signal" size={32} />
                        </div>
                    ) : error ? (
                        <div className="text-red-400 font-mono p-4 bg-red-400/10 border border-red-400/30 rounded">
                            {error}
                        </div>
                    ) : editable ? (
                        <textarea
                            value={editValue}
                            onChange={(e) => setEditValue(e.target.value)}
                            className="w-full h-48 bg-black/50 border border-ghost/30 text-signal p-3 font-mono text-sm focus:border-signal outline-none rounded"
                        />
                    ) : (
                        <pre className="text-sm text-gray-300 font-mono whitespace-pre-wrap bg-black/50 p-4 rounded border border-ghost/20 overflow-x-auto">
                            {content || 'No content available.'}
                        </pre>
                    )}
                </div>
                <div className="p-4 border-t border-ghost/30 flex justify-end gap-2">
                    {editable && onSave && (
                        <button 
                            onClick={() => { onSave(editValue); onClose(); }}
                            className="px-4 py-2 bg-signal text-void font-mono font-bold rounded hover:bg-white transition-colors"
                        >
                            Save
                        </button>
                    )}
                    <button 
                        onClick={onClose}
                        className="px-4 py-2 border border-ghost/30 text-ghost font-mono rounded hover:text-signal hover:border-signal transition-colors"
                    >
                        {editable ? 'Cancel' : 'Close'}
                    </button>
                </div>
            </motion.div>
        </div>,
        document.body
    );
};

const PayloadRow = ({ 
    payload, 
    onDelete, 
    onRestore, 
    onToggleAlert, 
    onToggleAllowed,
    onRebuild,
    onExportConfig,
    showDeleted,
    isCombat = false
}: PayloadRowProps) => {
    const [showMenu, setShowMenu] = useState(false);
    const [menuPosition, setMenuPosition] = useState({ top: 0, left: 0 });
    const [showDetails, setShowDetails] = useState(false);
    const buttonRef = useRef<HTMLButtonElement>(null);
    const portalMenuRef = useRef<HTMLDivElement>(null);
    
    // Dialog states
    const [showRenameDialog, setShowRenameDialog] = useState(false);
    const [showDescriptionDialog, setShowDescriptionDialog] = useState(false);
    const [showBuildMessageDialog, setShowBuildMessageDialog] = useState(false);
    const [showBuildErrorDialog, setShowBuildErrorDialog] = useState(false);
    const [showRedirectRulesDialog, setShowRedirectRulesDialog] = useState(false);
    const [showConfigCheckDialog, setShowConfigCheckDialog] = useState(false);
    const [showIOCDialog, setShowIOCDialog] = useState(false);
    const [showSampleMessageDialog, setShowSampleMessageDialog] = useState(false);
    
    // Loading states for queries
    const [redirectRulesContent, setRedirectRulesContent] = useState('');
    const [configCheckContent, setConfigCheckContent] = useState('');
    const [iocContent, setIOCContent] = useState('');
    const [sampleMessageContent, setSampleMessageContent] = useState('');
    const [dialogLoading, setDialogLoading] = useState(false);
    const [dialogError, setDialogError] = useState('');
    
    // Mutations
    const [updateFilename] = useMutation(updateFilenameMutation, {
        onCompleted: () => snackActions.success('Filename updated'),
        onError: (e) => snackActions.error('Failed to update filename: ' + e.message)
    });
    
    const [updateDescription] = useMutation(updatePayloadDescriptionMutation, {
        onCompleted: () => snackActions.success('Description updated'),
        onError: (e) => snackActions.error('Failed to update description: ' + e.message)
    });
    
    const [createFakeCallback] = useMutation(createFakeCallbackMutation, {
        onCompleted: (data) => {
            if (data.createFakeCallback.status === 'success') {
                snackActions.success('Fake callback created!');
            } else {
                snackActions.error(data.createFakeCallback.error);
            }
        },
        onError: (e) => snackActions.error('Failed to create fake callback: ' + e.message)
    });
    
    // Lazy queries
    const [fetchRedirectRules] = useLazyQuery(generateRedirectRulesQuery, {
        fetchPolicy: 'network-only',
        onCompleted: (data) => {
            setDialogLoading(false);
            if (data.redirectRules.status === 'success') {
                setRedirectRulesContent(data.redirectRules.output || 'No redirect rules generated.');
            } else {
                setDialogError(data.redirectRules.error);
            }
        },
        onError: (e) => { setDialogLoading(false); setDialogError(e.message); }
    });
    
    const [fetchConfigCheck] = useLazyQuery(checkAgentConfigQuery, {
        fetchPolicy: 'network-only',
        onCompleted: (data) => {
            setDialogLoading(false);
            if (data.config_check.status === 'success') {
                setConfigCheckContent(data.config_check.output || 'Configuration is valid.');
            } else {
                setDialogError(data.config_check.error);
            }
        },
        onError: (e) => { setDialogLoading(false); setDialogError(e.message); }
    });
    
    const [fetchIOCs] = useLazyQuery(generateIOCsQuery, {
        fetchPolicy: 'network-only',
        onCompleted: (data) => {
            setDialogLoading(false);
            if (data.getIOC.status === 'success') {
                setIOCContent(JSON.stringify(data.getIOC.iocs, null, 2));
            } else {
                setDialogError(data.getIOC.error);
            }
        },
        onError: (e) => { setDialogLoading(false); setDialogError(e.message); }
    });
    
    const [fetchSampleMessage] = useLazyQuery(generateSampleMessageQuery, {
        fetchPolicy: 'network-only',
        onCompleted: (data) => {
            setDialogLoading(false);
            if (data.getSampleMessage.status === 'success') {
                setSampleMessageContent(data.getSampleMessage.message || 'No sample message available.');
            } else {
                setDialogError(data.getSampleMessage.error);
            }
        },
        onError: (e) => { setDialogLoading(false); setDialogError(e.message); }
    });

    const filename = payload.filemetum?.filename_text 
        ? b64DecodeUnicode(payload.filemetum.filename_text) 
        : 'N/A';

    const handleDownload = () => {
        if (payload.filemetum?.agent_file_id) {
            const link = document.createElement('a');
            link.href = `/api/v1.4/files/download/${payload.filemetum.agent_file_id}`;
            link.click();
        }
    };

    // Close menu when clicking outside
    useEffect(() => {
        if (!showMenu) return;
        
        const handleClickOutside = (event: MouseEvent) => {
            const target = event.target as Node;
            const isOutsideButton = buttonRef.current && !buttonRef.current.contains(target);
            const isOutsidePortal = portalMenuRef.current && !portalMenuRef.current.contains(target);
            
            if (isOutsideButton && isOutsidePortal) {
                setShowMenu(false);
            }
        };
        
        // Delay adding listener to prevent immediate close
        const timeoutId = setTimeout(() => {
            document.addEventListener('mousedown', handleClickOutside);
        }, 0);
        
        return () => {
            clearTimeout(timeoutId);
            document.removeEventListener('mousedown', handleClickOutside);
        };
    }, [showMenu]);

    if (payload.deleted && !showDeleted) return null;

    const allTags = [...(payload.tags || []), ...(payload.filemetum?.tags || [])];

    return (
        <>
            <motion.tr
                initial={{ opacity: 0, y: 5 }}
                animate={{ opacity: 1, y: 0 }}
                exit={{ opacity: 0, y: -5 }}
                transition={{ duration: getAnimDuration(0.15, isCombat) }}
                className={cn(
                    "border-b border-gray-800 hover:bg-white/5 transition-colors",
                    payload.deleted && "opacity-50"
                )}
            >
                {/* Actions */}
                <td className="px-3 py-4">
                    <div className="flex items-center gap-1">
                        <div className="relative">
                            <button
                                ref={buttonRef}
                                onClick={(e) => {
                                    const rect = e.currentTarget.getBoundingClientRect();
                                    // Calculate position to prevent overflow
                                    const menuHeight = Math.min(500, window.innerHeight - 40); // Max menu height
                                    const menuWidth = 256; // w-64 = 256px
                                    
                                    // Calculate optimal top position
                                    let top = rect.bottom + 5;
                                    const spaceBelow = window.innerHeight - rect.bottom - 20;
                                    const spaceAbove = rect.top - 20;
                                    
                                    // If not enough space below, try above or adjust
                                    if (spaceBelow < 300 && spaceAbove > spaceBelow) {
                                        // Show above the button
                                        top = Math.max(10, rect.top - Math.min(menuHeight, spaceAbove));
                                    } else if (top + menuHeight > window.innerHeight - 10) {
                                        top = Math.max(10, window.innerHeight - menuHeight - 10);
                                    }
                                    
                                    // Ensure left doesn't overflow
                                    let left = rect.left;
                                    if (left + menuWidth > window.innerWidth - 10) {
                                        left = window.innerWidth - menuWidth - 10;
                                    }
                                    
                                    setMenuPosition({ top, left });
                                    setShowMenu(!showMenu);
                                }}
                                className="p-1.5 rounded hover:bg-signal/10 text-gray-500 hover:text-signal transition-colors"
                            >
                                <MoreVertical size={16} />
                            </button>
                            
                            {showMenu && createPortal(
                                <motion.div
                                    ref={portalMenuRef}
                                    initial={{ opacity: 0, scale: 0.95, y: -5 }}
                                    animate={{ opacity: 1, scale: 1, y: 0 }}
                                    exit={{ opacity: 0, scale: 0.95, y: -5 }}
                                    style={{ 
                                        position: 'fixed', 
                                        top: menuPosition.top, 
                                        left: menuPosition.left,
                                        zIndex: 99999,
                                        maxHeight: `calc(100vh - ${menuPosition.top + 20}px)`,
                                        minHeight: '200px'
                                    }}
                                    className="w-64 bg-void/95 backdrop-blur-md border border-signal/30 shadow-2xl shadow-signal/10 py-1 overflow-y-auto"
                                >
                                    {/* File Operations */}
                                    <div className="px-3 py-1 text-xs font-mono text-signal/50 uppercase tracking-wider border-b border-signal/10 bg-signal/5">File</div>
                                        
                                        <button
                                            onClick={() => { setShowRenameDialog(true); setShowMenu(false); }}
                                            className="w-full flex items-center gap-2 px-3 py-2 text-sm text-gray-300 hover:bg-signal/10 hover:text-signal transition-colors"
                                        >
                                            <Edit3 size={14} />
                                            Rename File
                                        </button>
                                        
                                        <button
                                            onClick={() => { setShowDescriptionDialog(true); setShowMenu(false); }}
                                            className="w-full flex items-center gap-2 px-3 py-2 text-sm text-gray-300 hover:bg-signal/10 hover:text-signal transition-colors"
                                        >
                                            <MessageSquare size={14} />
                                            Edit Description
                                        </button>
                                        
                                        <div className="border-t border-signal/10 my-1" />
                                        
                                        {/* View Operations */}
                                        <div className="px-3 py-1 text-xs font-mono text-ghost/50 uppercase tracking-wider">View</div>
                                        
                                        <button
                                            onClick={() => { setShowDetails(true); setShowMenu(false); }}
                                            className="w-full flex items-center gap-2 px-3 py-2 text-sm text-gray-300 hover:bg-signal/10 hover:text-signal transition-colors"
                                        >
                                            <Info size={14} />
                                            View Payload Configuration
                                        </button>
                                        
                                        <button
                                            onClick={() => { onExportConfig(payload.uuid); setShowMenu(false); }}
                                            className="w-full flex items-center gap-2 px-3 py-2 text-sm text-gray-300 hover:bg-signal/10 hover:text-signal transition-colors"
                                        >
                                            <FileText size={14} />
                                            Export Payload Config
                                        </button>
                                        
                                        <div className="border-t border-signal/10 my-1" />
                                        
                                        {/* Build Operations */}
                                        <div className="px-3 py-1 text-xs font-mono text-ghost/50 uppercase tracking-wider">Build</div>
                                        
                                        <button
                                            onClick={() => { setShowBuildMessageDialog(true); setShowMenu(false); }}
                                            className="w-full flex items-center gap-2 px-3 py-2 text-sm text-gray-300 hover:bg-signal/10 hover:text-signal transition-colors"
                                        >
                                            <FileText size={14} />
                                            View Build Message/Stdout
                                        </button>
                                        
                                        <button
                                            onClick={() => { setShowBuildErrorDialog(true); setShowMenu(false); }}
                                            className="w-full flex items-center gap-2 px-3 py-2 text-sm text-gray-300 hover:bg-signal/10 hover:text-signal transition-colors"
                                        >
                                            <AlertCircle size={14} />
                                            View Build Errors
                                        </button>
                                        
                                        <button
                                            onClick={() => { onRebuild(payload.uuid); setShowMenu(false); }}
                                            className="w-full flex items-center gap-2 px-3 py-2 text-sm text-gray-300 hover:bg-signal/10 hover:text-signal transition-colors"
                                        >
                                            <RefreshCw size={14} />
                                            Trigger New Build
                                        </button>
                                        
                                        <div className="border-t border-signal/10 my-1" />
                                        
                                        {/* Callback Settings */}
                                        <div className="px-3 py-1 text-xs font-mono text-ghost/50 uppercase tracking-wider">Callbacks</div>
                                        
                                        <button
                                            onClick={() => { onToggleAlert(payload.uuid, !payload.callback_alert); setShowMenu(false); }}
                                            className="w-full flex items-center gap-2 px-3 py-2 text-sm text-gray-300 hover:bg-signal/10 hover:text-signal transition-colors"
                                        >
                                            {payload.callback_alert ? <BellOff size={14} /> : <Bell size={14} />}
                                            {payload.callback_alert ? 'Disable Callback Alerts' : 'Enable Callback Alerts'}
                                        </button>
                                        
                                        <button
                                            onClick={() => { onToggleAllowed(payload.uuid, !payload.callback_allowed); setShowMenu(false); }}
                                            className="w-full flex items-center gap-2 px-3 py-2 text-sm text-gray-300 hover:bg-signal/10 hover:text-signal transition-colors"
                                        >
                                            {payload.callback_allowed ? <Ban size={14} /> : <CheckCircle size={14} />}
                                            {payload.callback_allowed ? 'Block New Callbacks' : 'Allow New Callbacks'}
                                        </button>
                                        
                                        <div className="border-t border-signal/10 my-1" />
                                        
                                        {/* Generate Operations */}
                                        <div className="px-3 py-1 text-xs font-mono text-ghost/50 uppercase tracking-wider">Generate</div>
                                        
                                        <button
                                            onClick={() => { 
                                                setDialogLoading(true);
                                                setDialogError('');
                                                setShowRedirectRulesDialog(true);
                                                fetchRedirectRules({ variables: { uuid: payload.uuid } });
                                                setShowMenu(false);
                                            }}
                                            className="w-full flex items-center gap-2 px-3 py-2 text-sm text-gray-300 hover:bg-signal/10 hover:text-signal transition-colors"
                                        >
                                            <ArrowLeftRight size={14} />
                                            Generate Redirect Rules
                                        </button>
                                        
                                        <button
                                            onClick={() => { 
                                                setDialogLoading(true);
                                                setDialogError('');
                                                setShowConfigCheckDialog(true);
                                                fetchConfigCheck({ variables: { uuid: payload.uuid } });
                                                setShowMenu(false);
                                            }}
                                            className="w-full flex items-center gap-2 px-3 py-2 text-sm text-gray-300 hover:bg-signal/10 hover:text-signal transition-colors"
                                        >
                                            <Settings size={14} />
                                            Check Agent C2 Configuration
                                        </button>
                                        
                                        <button
                                            onClick={() => { 
                                                setDialogLoading(true);
                                                setDialogError('');
                                                setShowIOCDialog(true);
                                                fetchIOCs({ variables: { uuid: payload.uuid } });
                                                setShowMenu(false);
                                            }}
                                            className="w-full flex items-center gap-2 px-3 py-2 text-sm text-gray-300 hover:bg-signal/10 hover:text-signal transition-colors"
                                        >
                                            <Fingerprint size={14} />
                                            Generate IOCs
                                        </button>
                                        
                                        <button
                                            onClick={() => { 
                                                setDialogLoading(true);
                                                setDialogError('');
                                                setShowSampleMessageDialog(true);
                                                fetchSampleMessage({ variables: { uuid: payload.uuid } });
                                                setShowMenu(false);
                                            }}
                                            className="w-full flex items-center gap-2 px-3 py-2 text-sm text-gray-300 hover:bg-signal/10 hover:text-signal transition-colors"
                                        >
                                            <FlaskConical size={14} />
                                            Generate Sample Message
                                        </button>
                                        
                                        <button
                                            onClick={() => { 
                                                if (window.confirm('Create a fake callback from this payload?')) {
                                                    createFakeCallback({ variables: { uuid: payload.uuid } });
                                                }
                                                setShowMenu(false);
                                            }}
                                            className="w-full flex items-center gap-2 px-3 py-2 text-sm text-gray-300 hover:bg-signal/10 hover:text-signal transition-colors"
                                        >
                                            <PhoneCall size={14} />
                                            Generate Fake Callback
                                        </button>
                                        
                                        <div className="border-t border-signal/10 my-1" />
                                        
                                        {/* Danger Zone */}
                                        <div className="px-3 py-1 text-xs font-mono text-red-400/50 uppercase tracking-wider border-b border-red-400/10 bg-red-400/5">Danger</div>
                                        
                                        {payload.deleted ? (
                                            <button
                                                onClick={() => { onRestore(payload.uuid); setShowMenu(false); }}
                                                className="w-full flex items-center gap-2 px-3 py-2 text-sm text-matrix hover:bg-matrix/10 transition-colors"
                                            >
                                                <RotateCcw size={14} />
                                                Restore Payload
                                            </button>
                                        ) : (
                                            <button
                                                onClick={() => { onDelete(payload.uuid); setShowMenu(false); }}
                                                className="w-full flex items-center gap-2 px-3 py-2 text-sm text-red-400 hover:bg-red-500/10 transition-colors"
                                            >
                                                <Trash2 size={14} />
                                                Delete Payload from Disk
                                            </button>
                                        )}
                                    </motion.div>,
                                document.body
                            )}
                        </div>
                        
                        {payload.build_phase === 'success' && payload.filemetum && (
                            <>
                                <button
                                    onClick={() => {
                                        const url = `${window.location.origin}/direct/download/${payload.filemetum?.agent_file_id}`;
                                        navigator.clipboard.writeText(url);
                                        snackActions.success('Public download link copied to clipboard');
                                    }}
                                    className="p-1.5 rounded hover:bg-signal/10 text-gray-500 hover:text-signal transition-colors"
                                    title="Copy Public Download Link"
                                >
                                    <Link size={16} />
                                </button>
                                <button
                                    onClick={handleDownload}
                                    className="p-1.5 rounded hover:bg-green-400/10 text-gray-500 hover:text-green-400 transition-colors"
                                    title="Download Payload"
                                >
                                    <Download size={16} />
                                </button>
                            </>
                        )}
                    </div>
                </td>

                {/* Agent Type - Color based on build status */}
                <td className="px-4 py-3">
                    <div className="flex items-center gap-2">
                        <div className={cn(
                            "w-8 h-8 rounded flex items-center justify-center border",
                            payload.build_phase === 'success' 
                                ? "bg-green-400/10 border-green-400/30" 
                                : payload.build_phase === 'error' 
                                    ? "bg-red-400/10 border-red-400/30"
                                    : "bg-yellow-400/10 border-yellow-400/30"
                        )}>
                            <Package size={16} className={cn(
                                payload.build_phase === 'success' 
                                    ? "text-green-400" 
                                    : payload.build_phase === 'error' 
                                        ? "text-red-400"
                                        : "text-yellow-400"
                            )} />
                        </div>
                        <span className={cn(
                            "font-mono text-sm",
                            payload.build_phase === 'success' 
                                ? "text-green-400" 
                                : payload.build_phase === 'error' 
                                    ? "text-red-400"
                                    : "text-yellow-400"
                        )}>
                            {payload.payloadtype.name}
                        </span>
                    </div>
                </td>

                {/* Filename - clickable to show details */}
                <td className="px-4 py-3 cursor-pointer hover:bg-signal/5" onClick={() => setShowDetails(true)}>
                    <div className="flex flex-col">
                        <span className="font-mono text-sm text-white truncate max-w-[250px] hover:text-signal transition-colors" title={filename}>
                            {filename}
                        </span>
                        <span className="text-xs text-gray-500 font-mono">
                            {payload.uuid.substring(0, 8)}...
                        </span>
                    </div>
                </td>

                {/* Build Status - clickable to show details */}
                <td className="px-4 py-3 cursor-pointer hover:bg-signal/5" onClick={() => setShowDetails(true)}>
                    <div className="flex flex-col">
                        <BuildStatusBadge phase={payload.build_phase} />
                        <BuildProgressSteps steps={payload.payload_build_steps} buildPhase={payload.build_phase} isCombat={isCombat} />
                    </div>
                </td>

                {/* Description - clickable to show details */}
                <td className="px-4 py-3 cursor-pointer hover:bg-signal/5" onClick={() => setShowDetails(true)}>
                    <span className="text-sm text-gray-400 line-clamp-2">{payload.description || '—'}</span>
                </td>

                {/* C2 Status - clickable to show details */}
                <td className="px-4 py-3 cursor-pointer hover:bg-signal/5" onClick={() => setShowDetails(true)}>
                    <C2StatusIndicator c2profiles={payload.payloadc2profiles} />
                </td>

                {/* Tags - clickable to show details */}
                <td className="px-4 py-3 cursor-pointer hover:bg-signal/5" onClick={() => setShowDetails(true)}>
                    <TagsDisplay tags={allTags} />
                </td>
            </motion.tr>

            {/* Details Modal */}
            <AnimatePresence>
                {showDetails && (
                    <motion.div
                        initial={{ opacity: 0 }}
                        animate={{ opacity: 1 }}
                        exit={{ opacity: 0 }}
                        className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4"
                        onClick={() => setShowDetails(false)}
                    >
                        <motion.div
                            initial={{ scale: 0.95, y: 20 }}
                            animate={{ scale: 1, y: 0 }}
                            exit={{ scale: 0.95, y: 20 }}
                            className="bg-void border border-signal/30 rounded-lg w-full max-w-5xl max-h-[85vh] overflow-hidden flex flex-col"
                            onClick={(e) => e.stopPropagation()}
                        >
                            {/* Header */}
                            <div className="p-6 border-b border-signal/30 bg-signal/5 flex items-center justify-between shrink-0">
                                <div>
                                    <h2 className="text-xl font-bold text-signal font-mono tracking-wider">PAYLOAD DETAILS</h2>
                                    <div className="flex items-center gap-2 mt-1">
                                        <span className="text-sm text-gray-400 font-mono">{payload.uuid}</span>
                                        <button 
                                            onClick={() => { navigator.clipboard.writeText(payload.uuid); snackActions.success('UUID copied'); }}
                                            className="text-ghost hover:text-signal transition-colors"
                                            title="Copy UUID"
                                        >
                                            <Copy size={14} />
                                        </button>
                                    </div>
                                </div>
                                <button onClick={() => setShowDetails(false)} className="text-ghost hover:text-signal transition-colors">
                                    <X size={24} />
                                </button>
                            </div>
                            
                            {/* Content - Scrollable */}
                            <div className="p-6 space-y-6 overflow-y-auto cyber-scrollbar flex-1">
                                {/* Quick Actions */}
                                <div className="flex flex-wrap gap-2">
                                    {payload.build_phase === 'success' && payload.filemetum && (
                                        <>
                                            <button
                                                onClick={handleDownload}
                                                className="flex items-center gap-2 px-3 py-2 bg-matrix/20 border border-matrix/30 text-matrix rounded hover:bg-matrix/30 transition-colors font-mono text-sm"
                                            >
                                                <Download size={14} />
                                                Download
                                            </button>
                                            <button
                                                onClick={() => {
                                                    const url = `${window.location.origin}/direct/download/${payload.filemetum?.agent_file_id}`;
                                                    navigator.clipboard.writeText(url);
                                                    snackActions.success('Public download link copied');
                                                }}
                                                className="flex items-center gap-2 px-3 py-2 bg-signal/10 border border-signal/30 text-signal rounded hover:bg-signal/20 transition-colors font-mono text-sm"
                                            >
                                                <Link size={14} />
                                                Copy Public Link
                                            </button>
                                        </>
                                    )}
                                    <button
                                        onClick={() => { onExportConfig(payload.uuid); }}
                                        className="flex items-center gap-2 px-3 py-2 bg-ghost/10 border border-ghost/30 text-gray-300 rounded hover:bg-ghost/20 transition-colors font-mono text-sm"
                                    >
                                        <FileText size={14} />
                                        Export Config
                                    </button>
                                    <button
                                        onClick={() => { onRebuild(payload.uuid); }}
                                        className="flex items-center gap-2 px-3 py-2 bg-ghost/10 border border-ghost/30 text-gray-300 rounded hover:bg-ghost/20 transition-colors font-mono text-sm"
                                    >
                                        <RefreshCw size={14} />
                                        Rebuild
                                    </button>
                                </div>
                                
                                {/* Basic Info Grid */}
                                <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
                                    <div className="bg-black/30 p-4 rounded border border-ghost/20">
                                        <label className="text-xs text-ghost uppercase tracking-wider block mb-1">Payload Type</label>
                                        <p className="text-signal font-mono text-lg">{payload.payloadtype.name}</p>
                                        <p className="text-xs text-gray-500">v{payload.payloadtype.semver}</p>
                                    </div>
                                    <div className="bg-black/30 p-4 rounded border border-ghost/20">
                                        <label className="text-xs text-ghost uppercase tracking-wider block mb-1">Filename</label>
                                        <p className="text-white font-mono truncate" title={filename}>{filename}</p>
                                        {payload.filemetum?.agent_file_id && (
                                            <p className="text-xs text-gray-500 truncate">ID: {payload.filemetum.agent_file_id.substring(0, 12)}...</p>
                                        )}
                                    </div>
                                    <div className="bg-black/30 p-4 rounded border border-ghost/20">
                                        <label className="text-xs text-ghost uppercase tracking-wider block mb-1">Created</label>
                                        <p className="text-gray-300 font-mono">{toLocalTime(payload.timestamp, false)}</p>
                                    </div>
                                    <div className="bg-black/30 p-4 rounded border border-ghost/20">
                                        <label className="text-xs text-ghost uppercase tracking-wider block mb-1">Build Status</label>
                                        <BuildStatusBadge phase={payload.build_phase} />
                                    </div>
                                </div>

                                {/* Callback Settings */}
                                <div className="grid grid-cols-2 gap-4">
                                    <div className={cn(
                                        "p-4 rounded border flex items-center justify-between",
                                        payload.callback_alert 
                                            ? "bg-matrix/10 border-matrix/30" 
                                            : "bg-black/30 border-ghost/20"
                                    )}>
                                        <div className="flex items-center gap-3">
                                            {payload.callback_alert ? <Bell size={20} className="text-matrix" /> : <BellOff size={20} className="text-ghost" />}
                                            <div>
                                                <p className="text-sm font-mono text-white">Callback Alerts</p>
                                                <p className="text-xs text-gray-500">{payload.callback_alert ? 'Notifications enabled' : 'Notifications disabled'}</p>
                                            </div>
                                        </div>
                                        <span className={cn(
                                            "px-2 py-1 rounded text-xs font-mono",
                                            payload.callback_alert ? "bg-matrix/20 text-matrix" : "bg-ghost/20 text-ghost"
                                        )}>
                                            {payload.callback_alert ? 'ON' : 'OFF'}
                                        </span>
                                    </div>
                                    <div className={cn(
                                        "p-4 rounded border flex items-center justify-between",
                                        payload.callback_allowed 
                                            ? "bg-matrix/10 border-matrix/30" 
                                            : "bg-red-500/10 border-red-500/30"
                                    )}>
                                        <div className="flex items-center gap-3">
                                            {payload.callback_allowed ? <CheckCircle size={20} className="text-matrix" /> : <Ban size={20} className="text-red-400" />}
                                            <div>
                                                <p className="text-sm font-mono text-white">New Callbacks</p>
                                                <p className="text-xs text-gray-500">{payload.callback_allowed ? 'New callbacks allowed' : 'New callbacks blocked'}</p>
                                            </div>
                                        </div>
                                        <span className={cn(
                                            "px-2 py-1 rounded text-xs font-mono",
                                            payload.callback_allowed ? "bg-matrix/20 text-matrix" : "bg-red-500/20 text-red-400"
                                        )}>
                                            {payload.callback_allowed ? 'ALLOWED' : 'BLOCKED'}
                                        </span>
                                    </div>
                                </div>

                                {/* Description */}
                                <div className="bg-black/30 p-4 rounded border border-ghost/20">
                                    <label className="text-xs text-ghost uppercase tracking-wider block mb-2">Description</label>
                                    <p className="text-gray-300">{payload.description || 'No description provided'}</p>
                                </div>

                                {/* C2 Profiles */}
                                <div className="bg-black/30 p-4 rounded border border-ghost/20">
                                    <label className="text-xs text-ghost uppercase tracking-wider block mb-3">C2 Profiles</label>
                                    <div className="flex flex-wrap gap-2">
                                        {payload.payloadc2profiles.length > 0 ? (
                                            payload.payloadc2profiles.map((pc, idx) => (
                                                <div 
                                                    key={idx}
                                                    className={cn(
                                                        "flex items-center gap-2 px-3 py-2 rounded border font-mono text-sm",
                                                        pc.c2profile.running && pc.c2profile.container_running
                                                            ? "bg-matrix/10 border-matrix/30 text-matrix"
                                                            : "bg-red-500/10 border-red-500/30 text-red-400"
                                                    )}
                                                >
                                                    <Radio size={14} className={pc.c2profile.running ? "animate-pulse" : ""} />
                                                    <span>{pc.c2profile.name}</span>
                                                    {pc.c2profile.is_p2p && (
                                                        <span className="text-xs bg-purple-500/20 text-purple-400 px-1 rounded">P2P</span>
                                                    )}
                                                    <span className={cn(
                                                        "text-xs px-1 rounded",
                                                        pc.c2profile.running ? "bg-matrix/20" : "bg-red-500/20"
                                                    )}>
                                                        {pc.c2profile.running ? 'RUNNING' : 'STOPPED'}
                                                    </span>
                                                </div>
                                            ))
                                        ) : (
                                            <span className="text-gray-500 text-sm">No C2 profiles configured</span>
                                        )}
                                    </div>
                                </div>

                                {/* Tags */}
                                {allTags.length > 0 && (
                                    <div className="bg-black/30 p-4 rounded border border-ghost/20">
                                        <label className="text-xs text-ghost uppercase tracking-wider block mb-3">Tags</label>
                                        <div className="flex flex-wrap gap-2">
                                            {allTags.map((tag, idx) => (
                                                <span 
                                                    key={idx}
                                                    className="px-2 py-1 rounded text-xs font-mono"
                                                    style={{ 
                                                        backgroundColor: `${tag.tagtype?.color || '#666'}20`,
                                                        borderColor: `${tag.tagtype?.color || '#666'}50`,
                                                        color: tag.tagtype?.color || '#888',
                                                        border: '1px solid'
                                                    }}
                                                >
                                                    {tag.tagtype?.name || 'Unknown'}
                                                </span>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {/* Build Message */}
                                {payload.build_message && (
                                    <div className="bg-black/30 p-4 rounded border border-ghost/20">
                                        <label className="text-xs text-ghost uppercase tracking-wider block mb-2">Build Message / Stdout</label>
                                        <pre className="p-3 bg-black/50 rounded border border-ghost/10 text-sm text-gray-300 font-mono overflow-x-auto max-h-40 cyber-scrollbar">
                                            {payload.build_message}
                                        </pre>
                                    </div>
                                )}

                                {/* Build Errors */}
                                {payload.build_stderr && (
                                    <div className="bg-red-500/5 p-4 rounded border border-red-500/30">
                                        <label className="text-xs text-red-400 uppercase tracking-wider block mb-2">Build Errors</label>
                                        <pre className="p-3 bg-black/50 rounded border border-red-500/20 text-sm text-red-400 font-mono overflow-x-auto max-h-40 cyber-scrollbar">
                                            {payload.build_stderr}
                                        </pre>
                                    </div>
                                )}

                                {/* Build Steps */}
                                {payload.payload_build_steps && payload.payload_build_steps.length > 0 && (
                                    <div className="bg-black/30 p-4 rounded border border-ghost/20">
                                        <label className="text-xs text-ghost uppercase tracking-wider block mb-3">Build Steps</label>
                                        <div className="space-y-2">
                                            {payload.payload_build_steps.map((step) => (
                                                <div 
                                                    key={step.id}
                                                    className={cn(
                                                        "p-3 rounded border",
                                                        step.step_success === true ? "bg-matrix/5 border-matrix/20" :
                                                        step.step_success === false ? "bg-red-500/5 border-red-500/20" :
                                                        "bg-ghost/5 border-ghost/20"
                                                    )}
                                                >
                                                    <div className="flex items-center justify-between">
                                                        <div className="flex items-center gap-2">
                                                            <span className="text-xs text-ghost bg-ghost/10 px-2 py-0.5 rounded">#{step.step_number}</span>
                                                            <span className="font-mono text-sm text-white">{step.step_name}</span>
                                                        </div>
                                                        <div className="flex items-center gap-2">
                                                            {step.step_skip && <span className="text-xs text-yellow-400 bg-yellow-400/10 px-2 py-0.5 rounded">SKIPPED</span>}
                                                            {step.step_success === true && <CheckCircle size={16} className="text-matrix" />}
                                                            {step.step_success === false && <XCircle size={16} className="text-red-400" />}
                                                        </div>
                                                    </div>
                                                    {step.step_stdout && (
                                                        <pre className="mt-2 text-xs text-gray-400 overflow-x-auto bg-black/30 p-2 rounded">{step.step_stdout}</pre>
                                                    )}
                                                    {step.step_stderr && (
                                                        <pre className="mt-2 text-xs text-red-400 overflow-x-auto bg-red-500/5 p-2 rounded">{step.step_stderr}</pre>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {/* Metadata */}
                                <div className="bg-black/30 p-4 rounded border border-ghost/20">
                                    <label className="text-xs text-ghost uppercase tracking-wider block mb-3">Metadata</label>
                                    <div className="grid grid-cols-2 gap-4 text-sm font-mono">
                                        <div>
                                            <span className="text-gray-500">Payload ID:</span>
                                            <span className="text-gray-300 ml-2">{payload.id}</span>
                                        </div>
                                        <div>
                                            <span className="text-gray-500">Auto Generated:</span>
                                            <span className={cn("ml-2", payload.auto_generated ? "text-yellow-400" : "text-gray-300")}>
                                                {payload.auto_generated ? 'Yes' : 'No'}
                                            </span>
                                        </div>
                                        <div>
                                            <span className="text-gray-500">Deleted:</span>
                                            <span className={cn("ml-2", payload.deleted ? "text-red-400" : "text-gray-300")}>
                                                {payload.deleted ? 'Yes' : 'No'}
                                            </span>
                                        </div>
                                        <div>
                                            <span className="text-gray-500">Type Version:</span>
                                            <span className="text-gray-300 ml-2">{payload.payload_type_semver}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            {/* Footer */}
                            <div className="p-4 border-t border-ghost/30 flex justify-end shrink-0 bg-void">
                                <button
                                    onClick={() => setShowDetails(false)}
                                    className="px-6 py-2 bg-ghost/20 hover:bg-ghost/30 text-white rounded transition-colors font-mono"
                                >
                                    Close
                                </button>
                            </div>
                        </motion.div>
                    </motion.div>
                )}
            </AnimatePresence>
            
            {/* Rename File Dialog */}
            <PayloadDialog
                open={showRenameDialog}
                onClose={() => setShowRenameDialog(false)}
                title="RENAME FILE"
                content={filename}
                editable
                onSave={(newFilename) => {
                    if (payload.filemetum?.id) {
                        // Note: bytea type in GraphQL handles the encoding automatically
                        updateFilename({ 
                            variables: { 
                                file_id: payload.filemetum.id, 
                                filename: newFilename 
                            } 
                        });
                    }
                }}
            />
            
            {/* Edit Description Dialog */}
            <PayloadDialog
                open={showDescriptionDialog}
                onClose={() => setShowDescriptionDialog(false)}
                title="EDIT DESCRIPTION"
                content={payload.description || ''}
                editable
                onSave={(newDescription) => {
                    updateDescription({ 
                        variables: { 
                            payload_id: payload.id, 
                            description: newDescription 
                        } 
                    });
                }}
            />
            
            {/* Build Message Dialog */}
            <PayloadDialog
                open={showBuildMessageDialog}
                onClose={() => setShowBuildMessageDialog(false)}
                title="BUILD MESSAGE / STDOUT"
                content={payload.build_message || 'No build message available.'}
            />
            
            {/* Build Error Dialog */}
            <PayloadDialog
                open={showBuildErrorDialog}
                onClose={() => setShowBuildErrorDialog(false)}
                title="BUILD ERRORS"
                content={payload.build_stderr || 'No build errors.'}
            />
            
            {/* Redirect Rules Dialog */}
            <PayloadDialog
                open={showRedirectRulesDialog}
                onClose={() => setShowRedirectRulesDialog(false)}
                title="REDIRECT RULES"
                content={redirectRulesContent}
                loading={dialogLoading}
                error={dialogError}
            />
            
            {/* Config Check Dialog */}
            <PayloadDialog
                open={showConfigCheckDialog}
                onClose={() => setShowConfigCheckDialog(false)}
                title="AGENT C2 CONFIGURATION CHECK"
                content={configCheckContent}
                loading={dialogLoading}
                error={dialogError}
            />
            
            {/* IOC Dialog */}
            <PayloadDialog
                open={showIOCDialog}
                onClose={() => setShowIOCDialog(false)}
                title="INDICATORS OF COMPROMISE"
                content={iocContent}
                loading={dialogLoading}
                error={dialogError}
            />
            
            {/* Sample Message Dialog */}
            <PayloadDialog
                open={showSampleMessageDialog}
                onClose={() => setShowSampleMessageDialog(false)}
                title="SAMPLE MESSAGE"
                content={sampleMessageContent}
                loading={dialogLoading}
                error={dialogError}
            />
        </>
    );
};

// ============================================
// Tab Types
// ============================================
type TabType = 'list' | 'create' | 'wrapper';

// ============================================
// Tab Navigation Component
// ============================================
const TabNavigation: React.FC<{
    activeTab: TabType;
    onTabChange: (tab: TabType) => void;
    totalPayloads: number;
}> = ({ activeTab, onTabChange, totalPayloads }) => {
    const tabs = [
        { id: 'list' as TabType, label: 'PAYLOADS', icon: List, count: totalPayloads },
        { id: 'create' as TabType, label: 'CREATE PAYLOAD', icon: Plus },
        { id: 'wrapper' as TabType, label: 'CREATE WRAPPER', icon: Package },
    ];

    return (
        <div className="flex items-center gap-1 border-b border-ghost/30">
            {tabs.map((tab) => {
                const Icon = tab.icon;
                const isActive = activeTab === tab.id;
                return (
                    <button
                        key={tab.id}
                        onClick={() => onTabChange(tab.id)}
                        className={cn(
                            "flex items-center gap-2 px-4 py-3 border-b-2 transition-all font-mono text-sm",
                            isActive
                                ? "border-signal text-signal bg-signal/5"
                                : "border-transparent text-gray-400 hover:text-signal hover:bg-signal/5"
                        )}
                    >
                        <Icon size={16} />
                        {tab.label}
                        {tab.count !== undefined && (
                            <span className={cn(
                                "px-1.5 py-0.5 text-xs rounded",
                                isActive ? "bg-signal/20" : "bg-ghost/20"
                            )}>
                                {tab.count}
                            </span>
                        )}
                    </button>
                );
            })}
        </div>
    );
};

// ============================================
// Payloads List Component (extracted from main)
// ============================================
const PayloadsListView: React.FC<{
    onSwitchToCreate: () => void;
    onSwitchToWrapper: () => void;
}> = ({ onSwitchToCreate, onSwitchToWrapper }) => {
    const { active: isCombat } = useBattleMode();
    const [fromNow] = useState((getSkewedNow()).toISOString());
    const [payloads, setPayloads] = useState<Payload[]>([]);
    const [showDeleted, setShowDeleted] = useState(false);
    const [showAutogenerated, setShowAutogenerated] = useState(false);
    const [loading, setLoading] = useState(true);
    const [pageData, setPageData] = useState({
        totalCount: 0,
        fetchLimit: 20,
        currentPage: 1
    });
    const mountedRef = useRef(true);

    // Subscription for real-time updates
    useSubscription(SUB_Payloads, {
        variables: { now: fromNow },
        fetchPolicy: "no-cache",
        onData: ({ data }) => {
            if (!mountedRef.current) return;
            const updated = data.data.payload_stream.reduce((prev: Payload[], cur: Payload) => {
                const index = prev.findIndex((p) => p.id === cur.id);
                if (index > -1) {
                    prev[index] = { ...cur };
                    return [...prev];
                }
                return [cur, ...prev];
            }, [...payloads]);
            updated.sort((a: Payload, b: Payload) => (a.id > b.id ? -1 : 1));
            setPayloads(updated);
        }
    });

    // Initial query
    useQuery(PayloadsQuery, {
        variables: { offset: 0, limit: pageData.fetchLimit, showDeleted: false, showAutogenerated: false },
        fetchPolicy: "no-cache",
        onCompleted: (data) => {
            setPageData(prev => ({ ...prev, totalCount: data.payload_aggregate.aggregate.count }));
            setPayloads(data.payload);
            setLoading(false);
        }
    });

    // Lazy query for pagination
    const [fetchNewPage] = useLazyQuery(PayloadsQuery, {
        onCompleted: (data) => {
            snackActions.dismiss();
            setPageData(prev => ({ ...prev, totalCount: data.payload_aggregate.aggregate.count }));
            setPayloads(data.payload);
            setLoading(false);
        }
    });

    // Mutations
    const [deletePayload] = useMutation(payloadsDelete, {
        onCompleted: (data) => {
            if (data.updatePayload.status === "success") {
                const updated = payloads.map(p => p.id === data.updatePayload.id ? { ...p, deleted: true } : p);
                setPayloads(updated);
                snackActions.success("Payload deleted");
            } else {
                snackActions.error(data.updatePayload.error);
            }
        },
        onError: () => snackActions.warning("Failed to delete payload")
    });

    const [restorePayload] = useMutation(restorePayloadMutation, {
        onCompleted: (data) => {
            const updated = payloads.map(p => p.id === data.updatePayload.id ? { ...p, deleted: false } : p);
            setPayloads(updated);
            snackActions.success("Payload restored");
        },
        onError: () => snackActions.warning("Failed to restore payload")
    });

    const [toggleCallbackAlert] = useMutation(payloadsCallbackAlert, {
        onCompleted: (data) => {
            const updated = payloads.map(p => p.id === data.updatePayload.id ? { ...p, callback_alert: data.updatePayload.callback_alert } : p);
            setPayloads(updated);
            snackActions.success(data.updatePayload.callback_alert ? "Callback alerts enabled" : "Callback alerts disabled");
        },
        onError: () => snackActions.warning("Failed to update callback alert")
    });

    const [toggleCallbackAllowed] = useMutation(payloadsCallbackAllowed, {
        onCompleted: (data) => {
            const updated = payloads.map(p => p.id === data.updatePayload.id ? { ...p, callback_allowed: data.updatePayload.callback_allowed } : p);
            setPayloads(updated);
            snackActions.success(data.updatePayload.callback_allowed ? "Callbacks allowed" : "Callbacks blocked");
        },
        onError: () => snackActions.warning("Failed to update callback allowed")
    });

    const [rebuildPayload] = useMutation(rebuildPayloadMutation, {
        onCompleted: (data) => {
            if (data.rebuild_payload.status === "success") {
                snackActions.success("Rebuild triggered");
            } else {
                snackActions.error("Failed to rebuild: " + data.rebuild_payload.error);
            }
        },
        onError: (error) => snackActions.error("Failed to trigger rebuild: " + error.message)
    });

    const [exportConfig] = useLazyQuery(exportPayloadConfigQuery, {
        fetchPolicy: "no-cache",
        onCompleted: (data) => {
            if (data.exportPayloadConfig.status === "success") {
                const dataBlob = new Blob([data.exportPayloadConfig.config], { type: 'text/plain' });
                const element = document.createElement("a");
                element.href = URL.createObjectURL(dataBlob);
                element.download = "payload_config.json";
                document.body.appendChild(element);
                element.click();
                document.body.removeChild(element);
            } else {
                snackActions.error("Failed to export: " + data.exportPayloadConfig.error);
            }
        },
        onError: (error) => snackActions.error("Failed to export: " + error.message)
    });

    // Handlers
    const handleChangePage = (page: number) => {
        setLoading(true);
        setPageData(prev => ({ ...prev, currentPage: page }));
        fetchNewPage({ 
            variables: { 
                offset: (page - 1) * pageData.fetchLimit, 
                limit: pageData.fetchLimit, 
                showDeleted, 
                showAutogenerated 
            }
        });
    };

    const handleToggleDeleted = () => {
        setShowDeleted(!showDeleted);
        setLoading(true);
        fetchNewPage({ 
            variables: { 
                offset: 0, 
                limit: pageData.fetchLimit, 
                showDeleted: !showDeleted, 
                showAutogenerated 
            }
        });
    };

    const handleToggleAutogenerated = () => {
        setShowAutogenerated(!showAutogenerated);
        setLoading(true);
        fetchNewPage({ 
            variables: { 
                offset: 0, 
                limit: pageData.fetchLimit, 
                showDeleted, 
                showAutogenerated: !showAutogenerated 
            }
        });
    };

    useEffect(() => {
        return () => { mountedRef.current = false; };
    }, []);

    const totalPages = Math.ceil(pageData.totalCount / pageData.fetchLimit);

    return (
        <div className="flex-1 flex flex-col min-w-0 overflow-hidden">
            {/* Toolbar */}
            <div className="flex items-center justify-between mb-4">
                <div className="flex items-center gap-3">
                    <button
                        onClick={handleToggleDeleted}
                        className={cn(
                            "flex items-center gap-2 px-3 py-1.5 text-sm rounded border transition-colors",
                            showDeleted
                                ? "border-signal/50 text-signal bg-signal/10"
                                : "border-ghost/30 text-gray-400 hover:text-signal hover:border-signal/30"
                        )}
                    >
                        {showDeleted ? <Eye size={14} /> : <EyeOff size={14} />}
                        {showDeleted ? 'Showing Deleted' : 'Hide Deleted'}
                    </button>
                    <button
                        onClick={handleToggleAutogenerated}
                        className={cn(
                            "flex items-center gap-2 px-3 py-1.5 text-sm rounded border transition-colors",
                            showAutogenerated
                                ? "border-signal/50 text-signal bg-signal/10"
                                : "border-ghost/30 text-gray-400 hover:text-signal hover:border-signal/30"
                        )}
                    >
                        {showAutogenerated ? <Eye size={14} /> : <EyeOff size={14} />}
                        {showAutogenerated ? 'Showing Auto' : 'Hide Auto'}
                    </button>
                </div>
                <div className="flex items-center gap-2">
                    <button
                        onClick={onSwitchToCreate}
                        className="flex items-center gap-2 px-4 py-2 bg-signal hover:bg-signal/80 text-void font-medium rounded transition-colors text-sm"
                    >
                        <Plus size={16} />
                        New Payload
                    </button>
                    <button
                        onClick={onSwitchToWrapper}
                        className="flex items-center gap-2 px-4 py-2 bg-signal/10 hover:bg-signal/20 border border-signal/30 text-signal rounded transition-colors text-sm"
                    >
                        <Package size={16} />
                        Wrapper
                    </button>
                </div>
            </div>

            {/* Table */}
            <div className="flex-1 overflow-auto">
                {loading ? (
                    <div className="flex items-center justify-center h-64">
                        <Loader2 size={32} className="text-signal animate-spin" />
                    </div>
                ) : payloads.length === 0 ? (
                    <div className="flex flex-col items-center justify-center h-64 text-gray-500">
                        <Box size={48} className="mb-4" />
                        <p className="text-lg">No payloads found</p>
                        <button
                            onClick={onSwitchToCreate}
                            className="mt-4 flex items-center gap-2 px-4 py-2 bg-signal/10 hover:bg-signal/20 border border-signal/30 text-signal rounded transition-colors"
                        >
                            <Plus size={16} />
                            Create your first payload
                        </button>
                    </div>
                ) : (
                    <div className="border border-gray-800 rounded-lg overflow-hidden">
                        <table className="w-full">
                            <thead>
                                <tr className="border-b border-gray-700 bg-black/30">
                                    <th className="px-4 py-3 text-left text-xs text-gray-500 font-medium uppercase tracking-wider w-20"></th>
                                    <th className="px-4 py-3 text-left text-xs text-gray-500 font-medium uppercase tracking-wider">Agent</th>
                                    <th className="px-4 py-3 text-left text-xs text-gray-500 font-medium uppercase tracking-wider">File</th>
                                    <th className="px-4 py-3 text-left text-xs text-gray-500 font-medium uppercase tracking-wider">Progress</th>
                                    <th className="px-4 py-3 text-left text-xs text-gray-500 font-medium uppercase tracking-wider">Description</th>
                                    <th className="px-4 py-3 text-left text-xs text-gray-500 font-medium uppercase tracking-wider">C2 Status</th>
                                    <th className="px-4 py-3 text-left text-xs text-gray-500 font-medium uppercase tracking-wider">Tags</th>
                                </tr>
                            </thead>
                            <tbody>
                                <AnimatePresence>
                                    {payloads.map((payload) => (
                                        <PayloadRow
                                            key={payload.id}
                                            payload={payload}
                                            onDelete={(uuid) => deletePayload({ variables: { payload_uuid: uuid } })}
                                            onRestore={(uuid) => restorePayload({ variables: { payload_uuid: uuid } })}
                                            onToggleAlert={(uuid, alert) => toggleCallbackAlert({ variables: { payload_uuid: uuid, callback_alert: alert } })}
                                            onToggleAllowed={(uuid, allowed) => toggleCallbackAllowed({ variables: { payload_uuid: uuid, callback_allowed: allowed } })}
                                            onRebuild={(uuid) => rebuildPayload({ variables: { uuid } })}
                                            onExportConfig={(uuid) => exportConfig({ variables: { uuid } })}
                                            showDeleted={showDeleted}
                                            isCombat={isCombat}
                                        />
                                    ))}
                                </AnimatePresence>
                            </tbody>
                        </table>
                    </div>
                )}
            </div>

            {/* Pagination */}
            {totalPages > 1 && (
                <div className="border-t border-ghost/30 pt-4 mt-4 flex items-center justify-center gap-2">
                    <button
                        onClick={() => handleChangePage(1)}
                        disabled={pageData.currentPage === 1}
                        className="px-3 py-1.5 rounded border border-ghost/30 text-gray-400 hover:text-signal hover:border-signal/30 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                    >
                        First
                    </button>
                    <button
                        onClick={() => handleChangePage(pageData.currentPage - 1)}
                        disabled={pageData.currentPage === 1}
                        className="px-3 py-1.5 rounded border border-ghost/30 text-gray-400 hover:text-signal hover:border-signal/30 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                    >
                        Prev
                    </button>
                    
                    <span className="px-4 text-gray-400 font-mono text-sm">
                        Page {pageData.currentPage} of {totalPages}
                    </span>
                    
                    <button
                        onClick={() => handleChangePage(pageData.currentPage + 1)}
                        disabled={pageData.currentPage === totalPages}
                        className="px-3 py-1.5 rounded border border-ghost/30 text-gray-400 hover:text-signal hover:border-signal/30 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                    >
                        Next
                    </button>
                    <button
                        onClick={() => handleChangePage(totalPages)}
                        disabled={pageData.currentPage === totalPages}
                        className="px-3 py-1.5 rounded border border-ghost/30 text-gray-400 hover:text-signal hover:border-signal/30 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                    >
                        Last
                    </button>
                </div>
            )}
        </div>
    );
};

// ============================================
// GraphQL for Create Payload
// ============================================
const GET_PAYLOAD_TYPES = gql`
query getPayloadTypesQuery {
  payloadtype(where: {deleted: {_eq: false}, wrapper: {_eq: false}, agent_type: {_in: ["agent", "service"]}}) {
    id
    supported_os
    name
    note
    semver
    container_running
    author
    buildparameters(where: {deleted: {_eq: false}}, order_by: {ui_position: asc}) {
        id
        name
        description
        parameter_type
        default_value
        required
        choices
        group_name
        verifier_regex
    }
    payloadtypec2profiles {
        c2profile {
            name
            id
            description
            running
            container_running
            is_p2p
            c2profileparameters(where: {deleted: {_eq: false}}) {
                id
                name
                description
                parameter_type
                default_value
                required
                choices
                format_string
                randomize
            }
        }
    }
    commands(where: {deleted: {_eq: false}}, order_by: {cmd: asc}) {
        id
        cmd
        description
        help_cmd
        needs_admin
        attributes
    }
  }
}
`;

const CREATE_PAYLOAD = gql`
mutation createPayload($payload: String!) {
    createPayload(payloadDefinition: $payload) {
        error
        status
        uuid
    }
}
`;

// ============================================
// OS Info Helper
// ============================================
const getOSInfo = (os: string) => {
    const lower = os.toLowerCase();
    if (lower.includes('windows')) return { 
        desc: "Microsoft Windows operating systems including Windows 10, 11, and Server editions.",
        color: "text-blue-400",
        bg: "bg-blue-400/10",
        border: "border-blue-400/30"
    };
    if (lower.includes('mac') || lower.includes('darwin')) return { 
        desc: "Apple macOS desktop environment for Intel and Apple Silicon processors.",
        color: "text-gray-200",
        bg: "bg-gray-200/10",
        border: "border-gray-200/30"
    };
    if (lower.includes('linux')) return { 
        desc: "Linux-based operating systems including Ubuntu, CentOS, Debian, and more.",
        color: "text-yellow-400",
        bg: "bg-yellow-400/10",
        border: "border-yellow-400/30"
    };
    if (lower.includes('android')) return { 
        desc: "Android mobile operating system based on the Linux kernel.",
        color: "text-green-400",
        bg: "bg-green-400/10",
        border: "border-green-400/30"
    };
    if (lower.includes('chrome')) return { 
        desc: "Chrome OS and web-based operating system environments.",
        color: "text-red-400",
        bg: "bg-red-400/10",
        border: "border-red-400/30"
    };
    return { 
        desc: "Generic or custom operating system environment.",
        color: "text-signal",
        bg: "bg-signal/10",
        border: "border-signal/30"
    };
};

// ============================================
// Create Payload Embed Component
// ============================================
const PAYLOAD_STEPS = ['SELECT AGENT', 'CONFIGURATION', 'COMMANDS', 'C2 PROFILES', 'BUILD'];

const getOSIcon = (os: string) => {
    const lower = os.toLowerCase();
    if (lower.includes('windows')) return <Monitor size={20} />;
    if (lower.includes('mac') || lower.includes('darwin')) return <Command size={20} />;
    if (lower.includes('linux')) return <Terminal size={20} />;
    if (lower.includes('android') || lower.includes('ios')) return <Smartphone size={20} />;
    if (lower.includes('chrome')) return <Globe size={20} />;
    return <Server size={20} />;
};

interface C2ProfileParameter {
    id: number;
    name: string;
    description: string;
    parameter_type: string;
    default_value: any;
    required: boolean;
    choices: string[];
    format_string?: string;
    randomize?: boolean;
}

interface C2Profile {
    name: string;
    id: number;
    description: string;
    running: boolean;
    container_running: boolean;
    is_p2p: boolean;
    c2profileparameters: C2ProfileParameter[];
}

interface C2ProfileInstance {
    profile: C2Profile;
    instance_id: number;
    parameters: Record<string, any>;
}

interface PayloadTypeData {
    id: number;
    name: string;
    note: string;
    semver: string;
    author?: string;
    supported_os: string[];
    container_running: boolean;
    buildparameters: Array<{
        id: number;
        name: string;
        description: string;
        parameter_type: string;
        default_value: any;
        required: boolean;
        choices: string[];
        group_name?: string;
        verifier_regex?: string;
    }>;
    payloadtypec2profiles: Array<{
        c2profile: C2Profile;
    }>;
    commands: Array<{
        id: number;
        cmd: string;
        description: string;
        help_cmd: string;
        needs_admin: boolean;
        attributes?: any;
    }>;
}

// Command Tooltip Component
const CommandTooltip: React.FC<{
    cmd: PayloadTypeData['commands'][0];
    position: { x: number; y: number };
    isCombat?: boolean;
}> = ({ cmd, position, isCombat = false }) => {
    return createPortal(
        <motion.div
            initial={{ opacity: 0, scale: 0.95 }}
            animate={{ opacity: 1, scale: 1 }}
            exit={{ opacity: 0, scale: 0.95 }}
            transition={{ duration: getAnimDuration(0.1, isCombat) }}
            className="fixed z-[9999] w-80 pointer-events-none"
            style={{ top: position.y, left: position.x }}
        >
            {/* Cyberpunk styled tooltip */}
            <div className="bg-void/95 border border-signal backdrop-blur-xl shadow-[0_0_30px_rgba(0,255,255,0.2)] overflow-hidden">
                {/* Header with scanline effect */}
                <div className="bg-signal/10 p-3 border-b border-signal/30 relative overflow-hidden">
                    <div className="absolute inset-0 bg-gradient-to-r from-signal/5 to-transparent animate-pulse" />
                    <div className="flex items-center justify-between relative z-10">
                        <span className="font-bold font-mono text-signal text-sm flex items-center gap-2">
                            <Terminal size={14} /> {cmd.cmd}
                        </span>
                        {cmd.needs_admin && (
                            <span className="text-[10px] bg-red-900/50 text-red-400 px-1.5 py-0.5 border border-red-500/30 font-mono">
                                ELEVATED
                            </span>
                        )}
                    </div>
                </div>
                
                {/* Body */}
                <div className="p-4 space-y-3">
                    <div>
                        <div className="text-[10px] text-gray-500 font-mono mb-1 uppercase tracking-widest">
                            DESCRIPTION
                        </div>
                        <p className="text-xs text-gray-300 leading-relaxed">
                            {cmd.description || "No description provided."}
                        </p>
                    </div>
                    
                    {cmd.help_cmd && (
                        <div>
                            <div className="text-[10px] text-gray-500 font-mono mb-1 uppercase tracking-widest">
                                USAGE
                            </div>
                            <div className="text-xs text-signal/80 font-mono bg-black/50 p-2 border border-gray-800 break-all">
                                {cmd.help_cmd}
                            </div>
                        </div>
                    )}

                    {cmd.attributes && Object.keys(cmd.attributes).length > 0 && (
                        <div>
                            <div className="text-[10px] text-gray-500 font-mono mb-1 uppercase tracking-widest">
                                ATTRIBUTES
                            </div>
                            <div className="flex flex-wrap gap-1">
                                {Object.entries(cmd.attributes).map(([key, val]: [string, any]) => (
                                    val && (
                                        <span key={key} className="text-[10px] bg-signal/10 text-signal px-1.5 py-0.5 border border-signal/30 font-mono">
                                            {key.replace(/_/g, ' ').toUpperCase()}
                                        </span>
                                    )
                                ))}
                            </div>
                        </div>
                    )}
                </div>

                {/* Decorative corners */}
                <div className="absolute top-0 right-0 w-3 h-3 border-t border-r border-signal" />
                <div className="absolute bottom-0 left-0 w-3 h-3 border-b border-l border-signal" />
            </div>
        </motion.div>,
        document.body
    );
};

const CreatePayloadEmbed: React.FC<{
    onComplete: () => void;
}> = ({ onComplete }) => {
    const { active: isCombat } = useBattleMode();
    const [currentStep, setCurrentStep] = useState(0);
    const [selectedOS, setSelectedOS] = useState<string>('');
    const [selectedPayloadType, setSelectedPayloadType] = useState<PayloadTypeData | null>(null);
    const [buildParams, setBuildParams] = useState<Record<string, any>>({});
    const [selectedCommands, setSelectedCommands] = useState<string[]>([]);
    const [c2ProfileInstances, setC2ProfileInstances] = useState<C2ProfileInstance[]>([]);
    const [description, setDescription] = useState('Created via Minerva');
    const [filename, setFilename] = useState('');
    const [building, setBuilding] = useState(false);
    const [buildResult, setBuildResult] = useState<{ status: string; error?: string; uuid?: string } | null>(null);
    const [commandFilter, setCommandFilter] = useState('');
    
    // C2 Profile selection state - now requires explicit ADD action
    const [selectedC2ToAdd, setSelectedC2ToAdd] = useState<string>('');
    
    // Tooltip state
    const [hoveredCommand, setHoveredCommand] = useState<PayloadTypeData['commands'][0] | null>(null);
    const [tooltipPosition, setTooltipPosition] = useState({ x: 0, y: 0 });
    const tooltipTimer = useRef<NodeJS.Timeout | null>(null);

    const { data: payloadTypesData, loading: loadingTypes } = useQuery(GET_PAYLOAD_TYPES);
    const [createPayload] = useMutation(CREATE_PAYLOAD);

    // Group payload types by OS
    const { availableOS, payloadTypesByOS } = React.useMemo(() => {
        if (!payloadTypesData?.payloadtype) return { availableOS: [], payloadTypesByOS: {} };
        
        const osSet = new Set<string>();
        const osMap: Record<string, PayloadTypeData[]> = {};
        
        payloadTypesData.payloadtype.forEach((pt: PayloadTypeData) => {
            const osArray = Array.isArray(pt.supported_os) ? pt.supported_os : [];
            osArray.forEach((os: string) => {
                osSet.add(os);
                if (!osMap[os]) osMap[os] = [];
                osMap[os].push(pt);
            });
        });
        
        return { availableOS: Array.from(osSet).sort(), payloadTypesByOS: osMap };
    }, [payloadTypesData]);

    // Initialize build params when payload type is selected
    useEffect(() => {
        if (selectedPayloadType) {
            const params: Record<string, any> = {};
            selectedPayloadType.buildparameters.forEach(bp => {
                if (bp.parameter_type === 'Boolean') {
                    params[bp.name] = bp.default_value === 'true' || bp.default_value === true;
                } else {
                    params[bp.name] = bp.default_value;
                }
            });
            setBuildParams(params);
            setC2ProfileInstances([]);
            setSelectedCommands([]);
        }
    }, [selectedPayloadType]);

    // Group build parameters
    const groupedBuildParams = React.useMemo(() => {
        if (!selectedPayloadType) return {};
        return selectedPayloadType.buildparameters.reduce((acc, bp) => {
            const group = bp.group_name || 'BASIC OPTIONS';
            if (!acc[group]) acc[group] = [];
            acc[group].push(bp);
            return acc;
        }, {} as Record<string, typeof selectedPayloadType.buildparameters>);
    }, [selectedPayloadType]);

    // Filtered commands
    const filteredCommands = React.useMemo(() => {
        if (!selectedPayloadType) return [];
        if (!commandFilter) return selectedPayloadType.commands;
        return selectedPayloadType.commands.filter(c => 
            c.cmd.toLowerCase().includes(commandFilter.toLowerCase()) ||
            c.description?.toLowerCase().includes(commandFilter.toLowerCase())
        );
    }, [selectedPayloadType, commandFilter]);

    // C2 Profile Helpers
    const addC2ProfileInstance = (profile: C2Profile) => {
        const defaultParams: Record<string, any> = {};
        profile.c2profileparameters.forEach(p => {
            if (p.parameter_type === 'Boolean') {
                defaultParams[p.name] = p.default_value === 'true' || p.default_value === true;
            } else if (p.parameter_type === 'Date') {
                const tmpDate = new Date();
                tmpDate.setDate(tmpDate.getDate() + parseInt(String(p.default_value) || '30'));
                defaultParams[p.name] = tmpDate.toISOString().slice(0, 10);
            } else if (p.parameter_type === 'Dictionary') {
                // Dictionary default_value is a JSON string, parse it
                if (typeof p.default_value === 'string') {
                    try {
                        defaultParams[p.name] = JSON.parse(p.default_value);
                    } catch (e) {
                        defaultParams[p.name] = {};
                    }
                } else {
                    defaultParams[p.name] = p.default_value || {};
                }
            } else if (p.parameter_type === 'Array' || p.parameter_type === 'ChooseMultiple') {
                if (typeof p.default_value === 'string') {
                    try {
                        defaultParams[p.name] = JSON.parse(p.default_value);
                    } catch (e) {
                        defaultParams[p.name] = [];
                    }
                } else {
                    defaultParams[p.name] = p.default_value || [];
                }
            } else if (p.parameter_type === 'Number') {
                defaultParams[p.name] = Number(p.default_value) || 0;
            } else {
                defaultParams[p.name] = p.default_value;
            }
        });
        
        setC2ProfileInstances([...c2ProfileInstances, {
            profile,
            instance_id: Date.now(),
            parameters: defaultParams
        }]);
        // Clear selection after adding
        setSelectedC2ToAdd('');
    };

    const handleAddC2Profile = () => {
        if (!selectedC2ToAdd || !selectedPayloadType) return;
        const profile = selectedPayloadType.payloadtypec2profiles.find(
            p => p.c2profile.id === parseInt(selectedC2ToAdd)
        );
        if (profile) {
            addC2ProfileInstance(profile.c2profile);
        }
    };

    const removeC2ProfileInstance = (instanceId: number) => {
        setC2ProfileInstances(c2ProfileInstances.filter(i => i.instance_id !== instanceId));
    };

    const updateC2InstanceParam = (instanceId: number, paramName: string, value: any) => {
        setC2ProfileInstances(c2ProfileInstances.map(inst => 
            inst.instance_id === instanceId 
                ? { ...inst, parameters: { ...inst.parameters, [paramName]: value } }
                : inst
        ));
    };

    // Tooltip handlers
    const handleCommandMouseEnter = (e: React.MouseEvent, cmd: PayloadTypeData['commands'][0]) => {
        const offset = 15;
        const x = e.clientX + offset;
        const y = e.clientY + offset;
        const screenWidth = window.innerWidth;
        const screenHeight = window.innerHeight;
        const tooltipWidth = 320;
        const tooltipHeight = 250;
        
        const finalX = x + tooltipWidth > screenWidth ? e.clientX - tooltipWidth - offset : x;
        const finalY = y + tooltipHeight > screenHeight ? e.clientY - tooltipHeight - offset : y;
        
        setTooltipPosition({ x: finalX, y: finalY });
        tooltipTimer.current = setTimeout(() => {
            setHoveredCommand(cmd);
        }, 200);
    };

    const handleCommandMouseMove = (e: React.MouseEvent) => {
        if (hoveredCommand || tooltipTimer.current) {
            const offset = 15;
            const x = e.clientX + offset;
            const y = e.clientY + offset;
            const screenWidth = window.innerWidth;
            const screenHeight = window.innerHeight;
            const tooltipWidth = 320;
            const tooltipHeight = 250;
            
            const finalX = x + tooltipWidth > screenWidth ? e.clientX - tooltipWidth - offset : x;
            const finalY = y + tooltipHeight > screenHeight ? e.clientY - tooltipHeight - offset : y;
            setTooltipPosition({ x: finalX, y: finalY });
        }
    };

    const handleCommandMouseLeave = () => {
        if (tooltipTimer.current) {
            clearTimeout(tooltipTimer.current);
            tooltipTimer.current = null;
        }
        setHoveredCommand(null);
    };

    const handleBuild = async () => {
        if (!selectedPayloadType) return;

        setBuilding(true);
        setBuildResult(null);

        try {
            // Build parameters as array with name/value pairs
            const buildParameters = selectedPayloadType.buildparameters.map(bp => {
                let value = buildParams[bp.name] ?? bp.default_value;
                
                // Handle Dictionary type - parse if it's a string
                if (bp.parameter_type === 'Dictionary') {
                    if (typeof value === 'string') {
                        try {
                            value = JSON.parse(value);
                        } catch (e) {
                            value = {};
                        }
                    }
                }
                
                return { name: bp.name, value };
            });

            // C2 profiles - parameters should be an object
            const c2Profiles = c2ProfileInstances.map(inst => {
                const instanceParams: Record<string, any> = {};
                
                inst.profile.c2profileparameters.forEach(p => {
                    let value = inst.parameters[p.name] ?? p.default_value;
                    
                    // Handle Dictionary type
                    if (p.parameter_type === 'Dictionary') {
                        if (typeof value === 'string') {
                            try {
                                // Parse the JSON string
                                value = JSON.parse(value);
                            } catch (e) {
                                value = {};
                            }
                        }
                        // If it's already an object, use it as-is
                        if (typeof value === 'object' && value !== null) {
                            instanceParams[p.name] = value;
                        } else {
                            instanceParams[p.name] = {};
                        }
                    } else if (p.parameter_type === 'Array' || p.parameter_type === 'ChooseMultiple') {
                        // Handle array types
                        if (typeof value === 'string') {
                            try {
                                value = JSON.parse(value);
                            } catch (e) {
                                value = [];
                            }
                        }
                        instanceParams[p.name] = value;
                    } else if (p.parameter_type === 'Number') {
                        instanceParams[p.name] = Number(value);
                    } else if (p.parameter_type === 'Boolean') {
                        instanceParams[p.name] = value === true || value === 'true';
                    } else {
                        instanceParams[p.name] = value;
                    }
                });
                
                return {
                    c2_profile: inst.profile.name,
                    c2_profile_parameters: instanceParams
                };
            });

            // Use user-specified filename, or fallback to build params, or payload type name
            const finalFilename = filename || buildParams['output'] || buildParams['output_type'] || 
                             buildParams['filename'] || selectedPayloadType.name;

            const finishedPayload = {
                selected_os: selectedOS,
                payload_type: selectedPayloadType.name,
                filename: finalFilename,
                description: description,
                commands: selectedCommands,
                build_parameters: buildParameters,
                c2_profiles: c2Profiles
            };

            console.log("Payload definition:", JSON.stringify(finishedPayload, null, 2));

            const result = await createPayload({
                variables: { payload: JSON.stringify(finishedPayload) }
            });

            if (result.data?.createPayload?.status === 'success') {
                setBuildResult({ status: 'success', uuid: result.data.createPayload.uuid });
                snackActions.success('Payload build started!');
            } else {
                setBuildResult({ status: 'error', error: result.data?.createPayload?.error || 'Unknown error' });
                snackActions.error(result.data?.createPayload?.error || 'Build failed');
            }
        } catch (error: any) {
            setBuildResult({ status: 'error', error: error.message });
            snackActions.error('Build failed: ' + error.message);
        } finally {
            setBuilding(false);
        }
    };

    const canProceed = () => {
        switch (currentStep) {
            case 0: return selectedOS && selectedPayloadType;
            case 1: return true;
            case 2: return selectedCommands.length > 0;
            case 3: return c2ProfileInstances.length > 0 || selectedPayloadType?.payloadtypec2profiles.length === 0;
            case 4: return true;
            default: return false;
        }
    };

    return (
        <div className="flex-1 flex flex-col min-h-0 overflow-hidden">
            {/* Step Indicator - Matching CreateWrapper style */}
            <div className="flex items-center justify-center mb-8">
                {PAYLOAD_STEPS.map((step, index) => (
                    <React.Fragment key={step}>
                        <motion.div 
                            className="flex flex-col items-center gap-2"
                            initial={{ opacity: 0, y: -10 }}
                            animate={{ opacity: 1, y: 0 }}
                            transition={{ delay: index * 0.1 }}
                        >
                            <motion.div 
                                className={cn(
                                    "w-10 h-10 rounded-full flex items-center justify-center border-2 transition-all duration-300",
                                    index < currentStep 
                                        ? "bg-matrix border-matrix text-void"
                                        : index === currentStep
                                            ? "border-signal text-signal bg-signal/10"
                                            : "border-ghost/30 text-ghost"
                                )}
                                whileHover={{ scale: 1.1 }}
                                whileTap={{ scale: 0.95 }}
                            >
                                {index < currentStep ? (
                                    <Check size={18} strokeWidth={3} />
                                ) : (
                                    <span className="font-mono font-bold">{index + 1}</span>
                                )}
                            </motion.div>
                            <span className={cn(
                                "text-[10px] font-mono tracking-widest hidden lg:block text-center max-w-[80px]",
                                index <= currentStep ? "text-signal" : "text-ghost/50"
                            )}>
                                {step}
                            </span>
                        </motion.div>
                        {index < PAYLOAD_STEPS.length - 1 && (
                            <div className={cn(
                                "w-12 xl:w-20 h-0.5 mx-2 transition-all duration-500",
                                index < currentStep 
                                    ? "bg-matrix" 
                                    : "bg-ghost/20"
                            )} />
                        )}
                    </React.Fragment>
                ))}
            </div>

            {/* Step Content */}
            <div className="flex-1 border border-ghost/30 rounded-lg overflow-hidden flex flex-col min-h-0 bg-black/20">
                <div className="flex-1 overflow-y-auto overflow-x-hidden p-6 cyber-scrollbar">
                    <AnimatePresence mode="wait">
                        {/* Step 0: Select OS and Agent */}
                        {currentStep === 0 && (
                            <motion.div
                                key="step0"
                                initial={{ opacity: 0 }}
                                animate={{ opacity: 1 }}
                                exit={{ opacity: 0 }}
                                transition={{ duration: getAnimDuration(0.3, isCombat) }}
                                className="grid grid-cols-1 lg:grid-cols-2 gap-6"
                            >
                                {/* OS Selection */}
                                <div className="space-y-4">
                                    <h3 className="text-lg font-mono text-signal flex items-center gap-2">
                                        <span className="text-gray-600">01.</span> TARGET SYSTEM
                                    </h3>
                                    <div className="space-y-2">
                                        {loadingTypes ? (
                                            <div className="flex items-center justify-center py-8">
                                                <Loader2 className="animate-spin text-signal" size={24} />
                                            </div>
                                        ) : (
                                            availableOS.map(os => {
                                                const osInfo = getOSInfo(os);
                                                const agentCount = payloadTypesByOS[os]?.length || 0;
                                                return (
                                                    <button
                                                        key={os}
                                                        onClick={() => { setSelectedOS(os); setSelectedPayloadType(null); }}
                                                        className={cn(
                                                            "w-full p-4 border text-left transition-all group",
                                                            selectedOS === os
                                                                ? `${osInfo.border} ${osInfo.bg}`
                                                                : "border-gray-700 hover:border-gray-500 hover:bg-white/5"
                                                        )}
                                                    >
                                                        <div className="flex items-start gap-4">
                                                            <div className={cn(
                                                                "p-3 border transition-colors",
                                                                selectedOS === os 
                                                                    ? `${osInfo.border} ${osInfo.bg} ${osInfo.color}` 
                                                                    : "border-gray-600 text-gray-500 group-hover:text-gray-300"
                                                            )}>
                                                                {getOSIcon(os)}
                                                            </div>
                                                            <div className="flex-1 min-w-0">
                                                                <div className="flex items-center justify-between mb-1">
                                                                    <span className={cn(
                                                                        "font-mono font-bold text-lg",
                                                                        selectedOS === os ? osInfo.color : "text-white"
                                                                    )}>
                                                                        {os}
                                                                    </span>
                                                                    <span className="text-xs bg-gray-800 px-2 py-0.5 text-gray-400 font-mono">
                                                                        {agentCount} AGENT{agentCount !== 1 ? 'S' : ''}
                                                                    </span>
                                                                </div>
                                                                <p className="text-xs text-gray-500 leading-relaxed">
                                                                    {osInfo.desc}
                                                                </p>
                                                            </div>
                                                            <ChevronRight className={cn(
                                                                "transition-all mt-2",
                                                                selectedOS === os ? `opacity-100 ${osInfo.color}` : "opacity-0 group-hover:opacity-50 text-gray-500"
                                                            )} size={18} />
                                                        </div>
                                                    </button>
                                                );
                                            })
                                        )}
                                    </div>
                                </div>

                                {/* Agent Selection */}
                                <div className="space-y-4">
                                    <h3 className="text-lg font-mono text-signal flex items-center gap-2">
                                        <span className="text-gray-600">02.</span> AGENT TYPE
                                    </h3>
                                    <AnimatePresence mode="wait">
                                        {!selectedOS ? (
                                            <motion.div
                                                key="no-os"
                                                initial={{ opacity: 0 }}
                                                animate={{ opacity: 1 }}
                                                exit={{ opacity: 0 }}
                                                transition={{ duration: getAnimDuration(0.2, isCombat) }}
                                                className="border border-dashed border-gray-700 p-8 text-center text-gray-600 font-mono h-[300px] flex items-center justify-center"
                                            >
                                                <div>
                                                    <Package size={48} className="mx-auto mb-4 opacity-30" />
                                                    <p>SELECT TARGET SYSTEM FIRST</p>
                                                </div>
                                            </motion.div>
                                        ) : (
                                            <motion.div
                                                key={`os-${selectedOS}`}
                                                initial={{ opacity: 0 }}
                                                animate={{ opacity: 1 }}
                                                exit={{ opacity: 0 }}
                                                transition={{ duration: getAnimDuration(0.3, isCombat) }}
                                                className="space-y-2 max-h-[400px] overflow-y-auto cyber-scrollbar pr-2"
                                            >
                                                {payloadTypesByOS[selectedOS]?.map((pt: PayloadTypeData, index: number) => (
                                                    <motion.button
                                                        key={pt.id}
                                                        initial={{ opacity: 0, y: 20 }}
                                                        animate={{ opacity: 1, y: 0 }}
                                                        transition={{ 
                                                            duration: getAnimDuration(0.3, isCombat),
                                                            delay: getAnimDuration(index * 0.05, isCombat)
                                                        }}
                                                        onClick={() => setSelectedPayloadType(pt)}
                                                        className={cn(
                                                            "w-full p-4 border text-left transition-all group",
                                                            selectedPayloadType?.id === pt.id
                                                                ? "border-signal bg-signal/10"
                                                                : "border-gray-700 hover:border-gray-500 hover:bg-white/5"
                                                        )}
                                                    >
                                                        <div className="flex items-center justify-between mb-2">
                                                            <div className="flex items-center gap-2">
                                                                <span className={cn(
                                                                    "font-mono font-bold",
                                                                    selectedPayloadType?.id === pt.id ? "text-signal" : "text-white"
                                                                )}>
                                                                    {pt.name}
                                                                </span>
                                                                {pt.container_running ? (
                                                                    <span className="w-2 h-2 rounded-full bg-green-400 animate-pulse" />
                                                                ) : (
                                                                    <span className="w-2 h-2 rounded-full bg-red-400" />
                                                                )}
                                                            </div>
                                                            <span className="text-xs bg-gray-800 px-2 py-0.5 text-gray-400 font-mono">
                                                                v{pt.semver}
                                                            </span>
                                                        </div>
                                                        <p className="text-xs text-gray-500 line-clamp-2 mb-2">{pt.note}</p>
                                                        <div className="flex items-center gap-4 text-[10px] text-gray-600 font-mono">
                                                            <span>{pt.commands?.length || 0} commands</span>
                                                            <span>{pt.payloadtypec2profiles?.length || 0} C2 profiles</span>
                                                            {pt.author && <span>by {pt.author}</span>}
                                                        </div>
                                                        {!pt.container_running && (
                                                            <div className="mt-2 flex items-center gap-1 text-yellow-500 text-xs">
                                                                <AlertTriangle size={12} />
                                                                Container not running
                                                            </div>
                                                        )}
                                                    </motion.button>
                                                ))}
                                            </motion.div>
                                        )}
                                    </AnimatePresence>
                                </div>
                            </motion.div>
                        )}

                        {/* Step 1: Build Parameters - Table Style */}
                        {currentStep === 1 && selectedPayloadType && (
                            <motion.div
                                key="step1"
                                initial={{ opacity: 0, x: 20 }}
                                animate={{ opacity: 1, x: 0 }}
                                exit={{ opacity: 0, x: -20 }}
                                transition={{ duration: getAnimDuration(0.3, isCombat) }}
                                className="space-y-6"
                            >
                                {/* Description field */}
                                <div className="border border-gray-700 bg-black/40">
                                    <div className="bg-white/5 p-2 px-4 font-mono font-bold text-signal border-b border-gray-700 uppercase tracking-widest text-sm">
                                        PAYLOAD INFO
                                    </div>
                                    <table className="w-full">
                                        <tbody>
                                            <tr className="border-b border-gray-800/50 hover:bg-white/5 transition-colors">
                                                <td className="p-4 align-top w-1/3 border-r border-gray-800/30">
                                                    <div className="font-bold text-signal font-mono mb-1">filename</div>
                                                    <div className="text-xs text-gray-400">Output filename for the payload (e.g., agent.exe)</div>
                                                </td>
                                                <td className="p-4">
                                                    <input
                                                        type="text"
                                                        value={filename}
                                                        onChange={(e) => setFilename(e.target.value)}
                                                        placeholder={selectedPayloadType?.name || 'payload'}
                                                        className="w-full bg-black/30 border border-gray-700 text-signal p-2 font-mono text-sm focus:border-signal outline-none transition-colors focus:bg-white/5"
                                                    />
                                                </td>
                                            </tr>
                                            <tr className="border-b border-gray-800/50 hover:bg-white/5 transition-colors">
                                                <td className="p-4 align-top w-1/3 border-r border-gray-800/30">
                                                    <div className="font-bold text-signal font-mono mb-1">description</div>
                                                    <div className="text-xs text-gray-400">A description for this payload</div>
                                                </td>
                                                <td className="p-4">
                                                    <input
                                                        type="text"
                                                        value={description}
                                                        onChange={(e) => setDescription(e.target.value)}
                                                        className="w-full bg-black/30 border border-gray-700 text-signal p-2 font-mono text-sm focus:border-signal outline-none transition-colors focus:bg-white/5"
                                                    />
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                {/* Grouped Build Parameters */}
                                {Object.entries(groupedBuildParams).map(([groupName, params]) => (
                                    <div key={groupName} className="border border-gray-700 bg-black/40">
                                        <div className="bg-white/5 p-2 px-4 font-mono font-bold text-signal border-b border-gray-700 uppercase tracking-widest text-sm">
                                            {groupName}
                                        </div>
                                        <table className="w-full">
                                            <tbody>
                                                {params.map(bp => (
                                                    <tr key={bp.id} className="border-b border-gray-800/50 hover:bg-white/5 transition-colors group">
                                                        <td className="p-4 align-top w-1/3 border-r border-gray-800/30">
                                                            <div className="font-bold text-signal font-mono mb-1 group-hover:text-white transition-colors">
                                                                {bp.name}
                                                            </div>
                                                            <div className="text-xs text-gray-400 leading-relaxed">{bp.description}</div>
                                                            {bp.required && (
                                                                <div className="text-[10px] text-red-400 mt-1 font-mono tracking-wider">* REQUIRED</div>
                                                            )}
                                                        </td>
                                                        <td className="p-4">
                                                            {bp.parameter_type === 'Boolean' ? (
                                                                <button
                                                                    onClick={() => setBuildParams({ ...buildParams, [bp.name]: !buildParams[bp.name] })}
                                                                    className={cn(
                                                                        "w-12 h-6 rounded-full p-1 transition-colors relative border",
                                                                        buildParams[bp.name] ? "bg-green-900/50 border-green-500" : "bg-gray-900/50 border-gray-700"
                                                                    )}
                                                                >
                                                                    <div className={cn(
                                                                        "w-3.5 h-3.5 rounded-full bg-white shadow-[0_0_8px_white] transition-transform duration-300",
                                                                        buildParams[bp.name] ? "translate-x-6" : "translate-x-0"
                                                                    )} />
                                                                </button>
                                                            ) : bp.parameter_type === 'ChooseOne' && bp.choices ? (
                                                                <CyberDropdown
                                                                    value={buildParams[bp.name] || ''}
                                                                    onChange={(val) => setBuildParams({ ...buildParams, [bp.name]: val })}
                                                                    options={(typeof bp.choices === 'string' ? JSON.parse(bp.choices) : bp.choices).map((choice: string) => ({
                                                                        label: choice,
                                                                        value: choice
                                                                    }))}
                                                                    size="sm"
                                                                />
                                                            ) : bp.parameter_type === 'Number' ? (
                                                                <input
                                                                    type="number"
                                                                    value={buildParams[bp.name] || ''}
                                                                    onChange={(e) => setBuildParams({ ...buildParams, [bp.name]: Number(e.target.value) })}
                                                                    className="w-full bg-black/30 border border-gray-700 text-signal p-2 font-mono text-sm focus:border-signal outline-none transition-colors focus:bg-white/5"
                                                                />
                                                            ) : (
                                                                <input
                                                                    type="text"
                                                                    value={buildParams[bp.name] || ''}
                                                                    onChange={(e) => setBuildParams({ ...buildParams, [bp.name]: e.target.value })}
                                                                    className="w-full bg-black/30 border border-gray-700 text-signal p-2 font-mono text-sm focus:border-signal outline-none transition-colors focus:bg-white/5"
                                                                />
                                                            )}
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                ))}
                            </motion.div>
                        )}

                        {/* Step 2: Commands with Tooltip - Fixed height with internal scroll */}
                        {currentStep === 2 && selectedPayloadType && (
                            <motion.div
                                key="step2"
                                initial={{ opacity: 0, x: 20 }}
                                animate={{ opacity: 1, x: 0 }}
                                exit={{ opacity: 0, x: -20 }}
                                transition={{ duration: getAnimDuration(0.3, isCombat) }}
                                className="flex flex-col h-full"
                            >
                                {/* Header with filter and actions */}
                                <div className="flex flex-col md:flex-row gap-4 mb-4 items-center">
                                    <div className="relative flex-1 w-full">
                                        <Search className="absolute left-3 top-2.5 text-ghost" size={18} />
                                        <input 
                                            type="text" 
                                            placeholder="FILTER_COMMANDS..." 
                                            value={commandFilter}
                                            onChange={(e) => setCommandFilter(e.target.value)}
                                            className="w-full bg-black/30 border border-ghost/30 py-2 pl-10 pr-4 text-signal font-mono text-sm focus:border-signal outline-none transition-colors focus:bg-white/5 rounded"
                                        />
                                    </div>
                                    <div className="flex gap-2 w-full md:w-auto">
                                        <motion.button 
                                            onClick={() => setSelectedCommands(filteredCommands.map(c => c.cmd))}
                                            whileHover={{ scale: 1.02 }}
                                            whileTap={{ scale: 0.98 }}
                                            className="flex-1 md:flex-none px-4 py-2 border border-matrix/50 bg-matrix/10 hover:bg-matrix/20 text-matrix text-xs font-mono font-bold transition-all flex items-center justify-center gap-2 rounded"
                                        >
                                            <Check size={14} /> SELECT_VISIBLE
                                        </motion.button>
                                        <motion.button 
                                            onClick={() => {
                                                const visibleCmds = filteredCommands.map(c => c.cmd);
                                                setSelectedCommands(selectedCommands.filter(c => !visibleCmds.includes(c)));
                                            }}
                                            whileHover={{ scale: 1.02 }}
                                            whileTap={{ scale: 0.98 }}
                                            className="flex-1 md:flex-none px-4 py-2 border border-red-500/50 bg-red-500/10 hover:bg-red-500/20 text-red-400 text-xs font-mono font-bold transition-all flex items-center justify-center gap-2 rounded"
                                        >
                                            <XCircle size={14} /> DESELECT_VISIBLE
                                        </motion.button>
                                    </div>
                                </div>

                                {/* Commands Grid - Fixed height with internal scrolling */}
                                <div className="border border-ghost/30 bg-black/20 rounded-lg p-3 h-[400px] overflow-y-auto cyber-scrollbar">
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-2">
                                        {filteredCommands.map((cmd, index) => (
                                            <motion.button
                                                key={cmd.id}
                                                initial={{ opacity: 0, y: 10 }}
                                                animate={{ opacity: 1, y: 0 }}
                                                transition={{ delay: Math.min(index * 0.02, 0.5) }}
                                                onClick={() => {
                                                    if (selectedCommands.includes(cmd.cmd)) {
                                                        setSelectedCommands(selectedCommands.filter(c => c !== cmd.cmd));
                                                    } else {
                                                        setSelectedCommands([...selectedCommands, cmd.cmd]);
                                                    }
                                                }}
                                                onMouseEnter={(e) => handleCommandMouseEnter(e, cmd)}
                                                onMouseMove={handleCommandMouseMove}
                                                onMouseLeave={handleCommandMouseLeave}
                                                className={cn(
                                                    "flex items-start gap-3 p-3 text-left border transition-all duration-150 group relative overflow-hidden rounded",
                                                    selectedCommands.includes(cmd.cmd)
                                                        ? "border-signal bg-signal/10" 
                                                        : "border-ghost/20 hover:border-ghost/50 bg-black/20 hover:bg-white/5"
                                                )}
                                            >
                                                <div className={cn(
                                                    "mt-0.5 shrink-0 transition-colors",
                                                    selectedCommands.includes(cmd.cmd) ? "text-signal" : "text-ghost/50 group-hover:text-ghost"
                                                )}>
                                                    {selectedCommands.includes(cmd.cmd) ? <CheckCircle size={14} /> : <Box size={14} />}
                                                </div>
                                                <div className="overflow-hidden min-w-0 z-10">
                                                    <div className={cn(
                                                        "font-bold font-mono text-xs truncate transition-colors",
                                                        selectedCommands.includes(cmd.cmd) ? "text-signal" : "text-gray-300 group-hover:text-white"
                                                    )}>
                                                        {cmd.cmd}
                                                    </div>
                                                    {cmd.description && (
                                                        <div className="text-[10px] text-ghost/60 line-clamp-1 mt-0.5 leading-tight">
                                                            {cmd.description}
                                                        </div>
                                                    )}
                                                </div>
                                            </motion.button>
                                        ))}
                                    </div>
                                </div>
                                
                                {/* Footer stats */}
                                <div className="mt-3 text-xs font-mono text-ghost flex justify-between px-1 border-t border-ghost/20 pt-3">
                                    <span>TOTAL: {selectedPayloadType.commands.length}</span>
                                    <span>SELECTED: <span className="text-signal font-bold">{selectedCommands.length}</span></span>
                                </div>

                                {/* Tooltip */}
                                <AnimatePresence>
                                    {hoveredCommand && (
                                        <CommandTooltip cmd={hoveredCommand} position={tooltipPosition} isCombat={isCombat} />
                                    )}
                                </AnimatePresence>
                            </motion.div>
                        )}

                        {/* Step 3: C2 Profiles - Select first, then ADD to show form */}
                        {currentStep === 3 && selectedPayloadType && (
                            <motion.div
                                key="step3"
                                initial={{ opacity: 0, x: 20 }}
                                animate={{ opacity: 1, x: 0 }}
                                exit={{ opacity: 0, x: -20 }}
                                transition={{ duration: getAnimDuration(0.3, isCombat) }}
                                className="space-y-6"
                            >
                                {/* Add Profile Section - Select first, then click ADD */}
                                <div className="bg-black/30 border border-ghost/30 rounded-lg p-4">
                                    <div className="flex flex-col md:flex-row gap-4 items-end">
                                        <div className="flex-1 w-full">
                                            <label className="block text-xs font-mono text-ghost mb-2 uppercase tracking-widest">
                                                SELECT_C2_PROFILE
                                            </label>
                                            <CyberDropdown
                                                value={selectedC2ToAdd}
                                                onChange={(val) => setSelectedC2ToAdd(val)}
                                                placeholder="-- SELECT_PROFILE --"
                                                options={selectedPayloadType.payloadtypec2profiles.map(({ c2profile }) => ({
                                                    label: `${c2profile.name} ${c2profile.is_p2p ? '(P2P)' : ''} - ${c2profile.description}`,
                                                    value: String(c2profile.id)
                                                }))}
                                            />
                                        </div>
                                        <motion.button 
                                            onClick={handleAddC2Profile}
                                            disabled={!selectedC2ToAdd}
                                            whileHover={{ scale: selectedC2ToAdd ? 1.02 : 1 }}
                                            whileTap={{ scale: selectedC2ToAdd ? 0.98 : 1 }}
                                            className={cn(
                                                "px-6 py-3 font-bold font-mono text-sm transition-all flex items-center gap-2 rounded border",
                                                selectedC2ToAdd 
                                                    ? "bg-signal text-void hover:bg-white border-transparent"
                                                    : "bg-ghost/20 text-ghost/50 cursor-not-allowed border-ghost/30"
                                            )}
                                        >
                                            <Plus size={16} /> ADD_PROFILE
                                        </motion.button>
                                    </div>
                                    
                                    {/* Show profile info when selected but not yet added */}
                                    <AnimatePresence>
                                        {selectedC2ToAdd && (
                                            <motion.div
                                                initial={{ opacity: 0, height: 0 }}
                                                animate={{ opacity: 1, height: 'auto' }}
                                                exit={{ opacity: 0, height: 0 }}
                                                className="mt-4 pt-4 border-t border-ghost/20"
                                            >
                                                {(() => {
                                                    const profile = selectedPayloadType.payloadtypec2profiles.find(
                                                        p => p.c2profile.id === parseInt(selectedC2ToAdd)
                                                    )?.c2profile;
                                                    if (!profile) return null;
                                                    return (
                                                        <div className="flex items-center gap-4 text-sm">
                                                            <div className="flex items-center gap-2">
                                                                <span className="text-signal font-mono font-bold">{profile.name}</span>
                                                                {profile.is_p2p && (
                                                                    <span className="text-[10px] bg-yellow-400/20 text-yellow-400 px-1.5 py-0.5 border border-yellow-400/30 font-mono rounded">
                                                                        P2P
                                                                    </span>
                                                                )}
                                                                <div className={cn(
                                                                    "flex items-center gap-1 text-xs",
                                                                    profile.running && profile.container_running ? "text-matrix" : "text-red-400"
                                                                )}>
                                                                    <span className={cn(
                                                                        "w-2 h-2 rounded-full",
                                                                        profile.running && profile.container_running ? "bg-matrix animate-pulse" : "bg-red-400"
                                                                    )} />
                                                                    {profile.running && profile.container_running ? "ONLINE" : "OFFLINE"}
                                                                </div>
                                                            </div>
                                                            <span className="text-ghost text-xs">|</span>
                                                            <span className="text-ghost text-xs">{profile.c2profileparameters.length} parameters</span>
                                                            <span className="text-ghost/60 text-xs flex-1">{profile.description}</span>
                                                        </div>
                                                    );
                                                })()}
                                            </motion.div>
                                        )}
                                    </AnimatePresence>
                                </div>

                                {/* Configured Profiles - Show forms after ADD */}
                                {c2ProfileInstances.length === 0 ? (
                                    <div className="text-center py-16 border border-dashed border-ghost/30 rounded-lg text-ghost font-mono">
                                        <Radio size={48} className="mx-auto mb-4 opacity-30" />
                                        <p>NO_C2_PROFILES_CONFIGURED</p>
                                        <p className="text-xs text-ghost/50 mt-2">Select a profile above and click ADD_PROFILE</p>
                                    </div>
                                ) : (
                                    <div className="space-y-4 max-h-[450px] overflow-y-auto cyber-scrollbar pr-2">
                                        {c2ProfileInstances.map((instance, idx) => (
                                            <motion.div 
                                                key={instance.instance_id} 
                                                initial={{ opacity: 0, y: 20 }}
                                                animate={{ opacity: 1, y: 0 }}
                                                className="border border-ghost/30 bg-black/30 rounded-lg overflow-hidden"
                                            >
                                                {/* Profile Header */}
                                                <div className="bg-signal/5 p-4 flex justify-between items-center border-b border-ghost/30">
                                                    <div className="flex items-center gap-3">
                                                        <Radio size={18} className="text-signal" />
                                                        <span className="text-signal font-bold font-mono text-lg">{instance.profile.name}</span>
                                                        <span className="text-xs text-ghost font-mono bg-black/30 px-2 py-1 rounded">Instance #{idx + 1}</span>
                                                        {instance.profile.is_p2p && (
                                                            <span className="text-[10px] bg-yellow-400/20 text-yellow-400 px-1.5 py-0.5 border border-yellow-400/30 font-mono rounded">
                                                                P2P
                                                            </span>
                                                        )}
                                                        <div className={cn(
                                                            "flex items-center gap-1 text-xs",
                                                            instance.profile.running && instance.profile.container_running ? "text-matrix" : "text-red-400"
                                                        )}>
                                                            <span className={cn(
                                                                "w-2 h-2 rounded-full",
                                                                instance.profile.running && instance.profile.container_running ? "bg-matrix animate-pulse" : "bg-red-400"
                                                            )} />
                                                            {instance.profile.running && instance.profile.container_running ? "ONLINE" : "OFFLINE"}
                                                        </div>
                                                    </div>
                                                    <motion.button 
                                                        onClick={() => removeC2ProfileInstance(instance.instance_id)}
                                                        whileHover={{ scale: 1.1 }}
                                                        whileTap={{ scale: 0.9 }}
                                                        className="text-ghost hover:text-red-500 transition-colors p-2"
                                                    >
                                                        <XCircle size={20} />
                                                    </motion.button>
                                                </div>
                                                
                                                {/* Profile Parameters Table */}
                                                <div className="p-4">
                                                    <table className="w-full">
                                                        <tbody>
                                                            {instance.profile.c2profileparameters.map(param => (
                                                                <tr key={param.id} className="border-b border-ghost/10 hover:bg-white/5 transition-colors">
                                                                    <td className="p-3 align-top w-1/3 border-r border-ghost/10">
                                                                        <div className="font-bold text-signal font-mono text-sm mb-1">{param.name}</div>
                                                                        <div className="text-xs text-ghost/60">{param.description}</div>
                                                                        {param.required && (
                                                                            <div className="text-[10px] text-red-400 mt-1 font-mono">* REQUIRED</div>
                                                                        )}
                                                                    </td>
                                                                    <td className="p-3">
                                                                        {param.parameter_type === 'Boolean' ? (
                                                                            <button
                                                                                onClick={() => updateC2InstanceParam(instance.instance_id, param.name, !instance.parameters[param.name])}
                                                                                className={cn(
                                                                                    "w-14 h-7 rounded-full p-1 transition-colors relative border",
                                                                                    instance.parameters[param.name] ? "bg-matrix/30 border-matrix" : "bg-ghost/20 border-ghost/30"
                                                                                )}
                                                                            >
                                                                                <div className={cn(
                                                                                    "w-4 h-4 rounded-full bg-white shadow-[0_0_10px_rgba(255,255,255,0.5)] transition-transform duration-300",
                                                                                    instance.parameters[param.name] ? "translate-x-7" : "translate-x-0"
                                                                                )} />
                                                                            </button>
                                                                        ) : param.parameter_type === 'ChooseOne' && param.choices ? (
                                                                            <CyberDropdown
                                                                                value={instance.parameters[param.name] || ''}
                                                                                onChange={(val) => updateC2InstanceParam(instance.instance_id, param.name, val)}
                                                                                options={(typeof param.choices === 'string' ? JSON.parse(param.choices) : param.choices).map((choice: string) => ({
                                                                                    label: choice,
                                                                                    value: choice
                                                                                }))}
                                                                                size="sm"
                                                                            />
                                                                        ) : param.parameter_type === 'Dictionary' ? (
                                                                            <textarea
                                                                                value={typeof instance.parameters[param.name] === 'string' 
                                                                                    ? instance.parameters[param.name] 
                                                                                    : JSON.stringify(instance.parameters[param.name], null, 2)}
                                                                                onChange={(e) => updateC2InstanceParam(instance.instance_id, param.name, e.target.value)}
                                                                                className="w-full bg-black/50 border border-ghost/30 text-signal p-2 font-mono text-xs focus:border-signal outline-none min-h-[100px] rounded"
                                                                            />
                                                                        ) : param.parameter_type === 'Date' ? (
                                                                            <input
                                                                                type="date"
                                                                                value={instance.parameters[param.name] || ''}
                                                                                onChange={(e) => updateC2InstanceParam(instance.instance_id, param.name, e.target.value)}
                                                                                className="bg-black/50 border border-ghost/30 text-signal p-2 font-mono text-sm focus:border-signal outline-none rounded"
                                                                            />
                                                                        ) : param.parameter_type === 'Number' ? (
                                                                            <input
                                                                                type="number"
                                                                                value={instance.parameters[param.name] || ''}
                                                                                onChange={(e) => updateC2InstanceParam(instance.instance_id, param.name, Number(e.target.value))}
                                                                                className="w-full bg-black/50 border border-ghost/30 text-signal p-2 font-mono text-sm focus:border-signal outline-none rounded"
                                                                            />
                                                                        ) : (
                                                                            <input
                                                                                type="text"
                                                                                value={instance.parameters[param.name] || ''}
                                                                                onChange={(e) => updateC2InstanceParam(instance.instance_id, param.name, e.target.value)}
                                                                                className="w-full bg-black/50 border border-ghost/30 text-signal p-2 font-mono text-sm focus:border-signal outline-none rounded"
                                                                            />
                                                                        )}
                                                                    </td>
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </motion.div>
                                        ))}
                                    </div>
                                )}
                            </motion.div>
                        )}

                        {/* Step 4: Build - Detailed Summary */}
                        {currentStep === 4 && selectedPayloadType && (
                            <motion.div
                                key="step4"
                                initial={{ opacity: 0, x: 20 }}
                                animate={{ opacity: 1, x: 0 }}
                                exit={{ opacity: 0, x: -20 }}
                                transition={{ duration: getAnimDuration(0.3, isCombat) }}
                                className="space-y-6"
                            >
                                {/* Header */}
                                <div className="flex items-center gap-3 mb-6">
                                    <div className="p-2 bg-signal/10 border border-signal/30 rounded">
                                        <FileText size={20} className="text-signal" />
                                    </div>
                                    <div>
                                        <h3 className="text-lg font-mono text-signal font-bold tracking-widest">BUILD_SUMMARY</h3>
                                        <p className="text-xs text-ghost">Review configuration before initiating build sequence</p>
                                    </div>
                                </div>

                                {/* Two Column Layout */}
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    {/* Left Column */}
                                    <div className="space-y-4">
                                        {/* Core Configuration */}
                                        <div className="border border-ghost/30 rounded-lg overflow-hidden bg-black/30">
                                            <div className="bg-signal/5 p-3 border-b border-ghost/30">
                                                <h4 className="text-sm font-mono text-signal font-bold tracking-widest flex items-center gap-2">
                                                    <Settings size={14} /> CORE_CONFIGURATION
                                                </h4>
                                            </div>
                                            <div className="p-4 space-y-3">
                                                <div className="flex justify-between items-center py-2 border-b border-ghost/10">
                                                    <span className="text-xs text-ghost uppercase tracking-widest">TARGET_OS</span>
                                                    <span className="text-signal font-mono font-bold">{selectedOS}</span>
                                                </div>
                                                <div className="flex justify-between items-center py-2 border-b border-ghost/10">
                                                    <span className="text-xs text-ghost uppercase tracking-widest">PAYLOAD_TYPE</span>
                                                    <span className="text-signal font-mono font-bold">{selectedPayloadType.name}</span>
                                                </div>
                                                <div className="flex justify-between items-center py-2 border-b border-ghost/10">
                                                    <span className="text-xs text-ghost uppercase tracking-widest">VERSION</span>
                                                    <span className="text-white font-mono">v{selectedPayloadType.semver}</span>
                                                </div>
                                                <div className="flex justify-between items-start py-2 border-b border-ghost/10">
                                                    <span className="text-xs text-ghost uppercase tracking-widest">FILENAME</span>
                                                    <span className="text-white font-mono text-right max-w-[200px] truncate">
                                                        {filename || buildParams['output'] || buildParams['output_type'] || buildParams['filename'] || selectedPayloadType.name}
                                                    </span>
                                                </div>
                                                <div className="flex justify-between items-start py-2">
                                                    <span className="text-xs text-ghost uppercase tracking-widest">DESCRIPTION</span>
                                                    <span className="text-white/80 text-xs text-right max-w-[200px]">{description}</span>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Build Parameters */}
                                        <div className="border border-ghost/30 rounded-lg overflow-hidden bg-black/30">
                                            <div className="bg-signal/5 p-3 border-b border-ghost/30">
                                                <h4 className="text-sm font-mono text-signal font-bold tracking-widest flex items-center gap-2">
                                                    <Sliders size={14} /> BUILD_PARAMETERS
                                                </h4>
                                            </div>
                                            <div className="p-4 max-h-[300px] overflow-y-auto cyber-scrollbar">
                                                <div className="space-y-2">
                                                    {selectedPayloadType.buildparameters.map(bp => (
                                                        <div key={bp.id} className="flex justify-between items-center py-2 border-b border-ghost/10 last:border-0">
                                                            <span className="text-xs text-ghost font-mono">{bp.name}</span>
                                                            <span className={cn(
                                                                "font-mono text-xs text-right max-w-[200px] truncate",
                                                                bp.parameter_type === 'Boolean' 
                                                                    ? buildParams[bp.name] ? "text-matrix" : "text-ghost/50"
                                                                    : "text-white"
                                                            )}>
                                                                {bp.parameter_type === 'Boolean' 
                                                                    ? (buildParams[bp.name] ? 'TRUE' : 'FALSE')
                                                                    : String(buildParams[bp.name] ?? bp.default_value)
                                                                }
                                                            </span>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Right Column */}
                                    <div className="space-y-4">
                                        {/* C2 Channels */}
                                        <div className="border border-ghost/30 rounded-lg overflow-hidden bg-black/30">
                                            <div className="bg-signal/5 p-3 border-b border-ghost/30">
                                                <h4 className="text-sm font-mono text-signal font-bold tracking-widest flex items-center gap-2">
                                                    <Radio size={14} /> C2_CHANNELS
                                                    <span className="text-xs text-ghost ml-auto font-normal">{c2ProfileInstances.length} configured</span>
                                                </h4>
                                            </div>
                                            <div className="p-4 max-h-[250px] overflow-y-auto cyber-scrollbar">
                                                {c2ProfileInstances.length === 0 ? (
                                                    <div className="text-center text-ghost/50 font-mono text-xs py-4">
                                                        NO_C2_PROFILES
                                                    </div>
                                                ) : (
                                                    <div className="space-y-4">
                                                        {c2ProfileInstances.map((inst, idx) => (
                                                            <div key={inst.instance_id} className="border-b border-ghost/10 pb-3 last:border-0 last:pb-0">
                                                                <div className="flex items-center gap-2 mb-2">
                                                                    <span className="text-signal font-mono font-bold text-sm">{inst.profile.name}</span>
                                                                    <span className="text-[10px] text-ghost bg-ghost/10 px-1.5 py-0.5 rounded">#{idx + 1}</span>
                                                                    {inst.profile.is_p2p && (
                                                                        <span className="text-[10px] text-yellow-400 bg-yellow-400/10 px-1.5 py-0.5 rounded">P2P</span>
                                                                    )}
                                                                </div>
                                                                <div className="space-y-1 pl-2 border-l-2 border-signal/30">
                                                                    {Object.entries(inst.parameters).slice(0, 5).map(([key, value]) => (
                                                                        <div key={key} className="flex justify-between text-[10px]">
                                                                            <span className="text-ghost font-mono">{key}</span>
                                                                            <span className="text-white/80 font-mono truncate max-w-[150px]">
                                                                                {typeof value === 'boolean' ? (value ? 'TRUE' : 'FALSE') : String(value)}
                                                                            </span>
                                                                        </div>
                                                                    ))}
                                                                    {Object.keys(inst.parameters).length > 5 && (
                                                                        <div className="text-[10px] text-ghost/50 font-mono">
                                                                            +{Object.keys(inst.parameters).length - 5} more parameters...
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                        </div>

                                        {/* Commands */}
                                        <div className="border border-ghost/30 rounded-lg overflow-hidden bg-black/30">
                                            <div className="bg-signal/5 p-3 border-b border-ghost/30">
                                                <h4 className="text-sm font-mono text-signal font-bold tracking-widest flex items-center gap-2">
                                                    <Terminal size={14} /> COMMANDS
                                                    <span className="text-xs text-ghost ml-auto font-normal">{selectedCommands.length} selected</span>
                                                </h4>
                                            </div>
                                            <div className="p-4 max-h-[200px] overflow-y-auto cyber-scrollbar">
                                                <div className="flex flex-wrap gap-1.5">
                                                    {selectedCommands.map(cmd => (
                                                        <motion.span 
                                                            key={cmd}
                                                            initial={{ opacity: 0, scale: 0.9 }}
                                                            animate={{ opacity: 1, scale: 1 }}
                                                            className="text-[10px] bg-signal/10 text-signal border border-signal/30 px-2 py-1 font-mono rounded hover:bg-signal/20 transition-colors"
                                                        >
                                                            {cmd}
                                                        </motion.span>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Build Result */}
                                <AnimatePresence>
                                    {buildResult && (
                                        <motion.div 
                                            initial={{ opacity: 0, y: 10 }}
                                            animate={{ opacity: 1, y: 0 }}
                                            exit={{ opacity: 0, y: -10 }}
                                            className={cn(
                                                "p-4 border rounded-lg",
                                                buildResult.status === 'success'
                                                    ? "bg-matrix/10 border-matrix/30 text-matrix"
                                                    : "bg-red-400/10 border-red-400/30 text-red-400"
                                            )}
                                        >
                                            {buildResult.status === 'success' ? (
                                                <div className="flex items-center gap-3">
                                                    <CheckCircle size={24} />
                                                    <div>
                                                        <div className="font-mono font-bold">BUILD_INITIATED</div>
                                                        <div className="text-xs opacity-80">UUID: {buildResult.uuid}</div>
                                                    </div>
                                                </div>
                                            ) : (
                                                <div className="flex items-center gap-3">
                                                    <XCircle size={24} />
                                                    <div>
                                                        <div className="font-mono font-bold">BUILD_FAILED</div>
                                                        <div className="text-xs opacity-80">{buildResult.error}</div>
                                                    </div>
                                                </div>
                                            )}
                                        </motion.div>
                                    )}
                                </AnimatePresence>

                                {/* Build Button */}
                                <motion.button
                                    onClick={handleBuild}
                                    disabled={building || buildResult?.status === 'success'}
                                    whileHover={{ scale: building || buildResult?.status === 'success' ? 1 : 1.01 }}
                                    whileTap={{ scale: building || buildResult?.status === 'success' ? 1 : 0.99 }}
                                    className={cn(
                                        "w-full py-4 font-mono font-bold transition-all flex items-center justify-center gap-3 rounded-lg text-lg tracking-widest",
                                        building || buildResult?.status === 'success'
                                            ? "bg-ghost/20 text-ghost/50 cursor-not-allowed border border-ghost/30"
                                            : "bg-gradient-to-r from-signal to-signal/80 text-void hover:from-white hover:to-signal hover:shadow-[0_0_30px_rgba(0,255,255,0.4)] border border-transparent"
                                    )}
                                >
                                    {building ? (
                                        <>
                                            <Loader2 className="animate-spin" size={24} />
                                            BUILDING_PAYLOAD...
                                        </>
                                    ) : buildResult?.status === 'success' ? (
                                        <>
                                            <CheckCircle size={24} />
                                            BUILD_INITIATED
                                        </>
                                    ) : (
                                        <>
                                            <Disc size={24} />
                                            INITIATE_BUILD_SEQUENCE
                                        </>
                                    )}
                                </motion.button>
                            </motion.div>
                        )}
                    </AnimatePresence>
                </div>

                {/* Footer Controls - Matching CreateWrapper style */}
                <div className="p-4 border-t border-ghost/30 flex justify-between items-center bg-black/30">
                    <motion.button
                        onClick={() => currentStep === 0 ? onComplete() : setCurrentStep(currentStep - 1)}
                        whileHover={{ scale: 1.02 }}
                        whileTap={{ scale: 0.98 }}
                        className="px-6 py-2.5 border border-ghost/30 text-ghost rounded-lg font-mono text-sm hover:text-signal hover:border-signal transition-all flex items-center gap-2"
                    >
                        <ChevronLeft size={16} />
                        {currentStep === 0 ? 'CANCEL' : 'BACK'}
                    </motion.button>
                    
                    {currentStep < PAYLOAD_STEPS.length - 1 && (
                        <motion.button
                            onClick={() => setCurrentStep(currentStep + 1)}
                            disabled={!canProceed()}
                            whileHover={{ scale: canProceed() ? 1.02 : 1 }}
                            whileTap={{ scale: canProceed() ? 0.98 : 1 }}
                            className="px-8 py-2.5 bg-signal text-void font-bold rounded-lg font-mono text-sm hover:bg-white disabled:opacity-50 disabled:cursor-not-allowed transition-all flex items-center gap-2"
                        >
                            NEXT <ChevronRight size={16} />
                        </motion.button>
                    )}
                    
                    {currentStep === PAYLOAD_STEPS.length - 1 && buildResult?.status === 'success' && (
                        <motion.button
                            onClick={onComplete}
                            whileHover={{ scale: 1.02 }}
                            whileTap={{ scale: 0.98 }}
                            className="px-8 py-2.5 bg-matrix text-void font-bold rounded-lg font-mono text-sm hover:bg-matrix/80 transition-all flex items-center gap-2"
                        >
                            <CheckCircle size={16} />
                            DONE
                        </motion.button>
                    )}
                </div>
            </div>
        </div>
    );
};

// ============================================
// Create Wrapper Embed Component
// ============================================
const CreateWrapperEmbed: React.FC<{
    onComplete: () => void;
}> = ({ onComplete }) => {
    return <CreateWrapperWizard embedded={true} onComplete={onComplete} />;
};

// ============================================
// Main Payloads Overview Page
// ============================================
const Payloads = () => {
    const { isSidebarCollapsed } = useAppStore();
    const [searchParams, setSearchParams] = useSearchParams();
    const me = useReactiveVar(meState);
    
    // Get initial tab from URL or default to 'list'
    const initialTab = (searchParams.get('tab') as TabType) || 'list';
    const [activeTab, setActiveTab] = useState<TabType>(initialTab);
    const [totalPayloads, setTotalPayloads] = useState(0);

    // Query just for count
    useQuery(PayloadsQuery, {
        variables: { offset: 0, limit: 1, showDeleted: false, showAutogenerated: false },
        fetchPolicy: "cache-and-network",
        onCompleted: (data) => {
            setTotalPayloads(data.payload_aggregate?.aggregate?.count || 0);
        }
    });

    const handleTabChange = (tab: TabType) => {
        setActiveTab(tab);
        setSearchParams({ tab });
    };

    // @ts-ignore
    const noOperation = (me?.user?.current_operation_id || 0) === 0;

    if (noOperation) {
        return (
            <div className="min-h-screen bg-void text-signal font-sans selection:bg-signal selection:text-void">
                <Sidebar />
                <div className={cn("transition-all duration-300 p-6 lg:p-12 min-h-screen flex items-center justify-center", isSidebarCollapsed ? "ml-16" : "ml-64")}>
                    <div className="text-center">
                        <Box size={48} className="mx-auto mb-4 text-gray-500" />
                        <h1 className="text-xl font-bold text-gray-400 mb-2">No Operation Selected</h1>
                        <p className="text-gray-500">Please select an operation to view payloads</p>
                    </div>
                </div>
            </div>
        );
    }

    return (
        <div className="min-h-screen bg-void text-signal font-sans selection:bg-signal selection:text-void">
            <Sidebar />
            
            <div className={cn("transition-all duration-300 p-6 lg:p-12 min-h-screen flex flex-col", isSidebarCollapsed ? "ml-16" : "ml-64")}>
                {/* Header - Changes based on active tab */}
                <header className="flex justify-between items-center mb-8 border-b border-ghost/30 pb-6">
                    <div className="flex items-center gap-4">
                        <div className={cn(
                            "p-3 border rounded",
                            activeTab === 'list' 
                                ? "border-signal bg-signal/10" 
                                : activeTab === 'create'
                                    ? "border-green-400 bg-green-400/10"
                                    : "border-yellow-400 bg-yellow-400/10"
                        )}>
                            {activeTab === 'list' ? (
                                <Box size={24} className="text-signal" />
                            ) : activeTab === 'create' ? (
                                <Plus size={24} className="text-green-400" />
                            ) : (
                                <Package size={24} className="text-yellow-400" />
                            )}
                        </div>
                        <div>
                            <h1 className="text-2xl font-bold tracking-widest">
                                {activeTab === 'list' 
                                    ? 'PAYLOADS OVERVIEW' 
                                    : activeTab === 'create'
                                        ? 'CREATE PAYLOAD'
                                        : 'CREATE WRAPPER'}
                            </h1>
                            <p className="text-xs text-gray-400 font-mono">
                                {activeTab === 'list' 
                                    ? '/root/payloads/list' 
                                    : activeTab === 'create'
                                        ? '/root/payloads/generate'
                                        : '/root/payloads/wrapper'}
                            </p>
                        </div>
                    </div>

                    {/* Stats Summary - Only show on list tab */}
                    {activeTab === 'list' && (
                        <div className="flex gap-6 text-xs font-mono items-center">
                            <div className="text-right border-l border-ghost/20 pl-6">
                                <div className="text-gray-400">TOTAL_PAYLOADS</div>
                                <div className="text-xl text-signal">{totalPayloads}</div>
                            </div>
                        </div>
                    )}

                    {/* Generate Payload Button - Show on list tab */}
                    {activeTab === 'list' && (
                        <button
                            onClick={() => handleTabChange('create')}
                            className="flex items-center gap-2 px-4 py-2 border border-signal text-signal hover:bg-signal hover:text-void font-mono text-sm transition-colors rounded"
                        >
                            <Plus size={16} />
                            GENERATE PAYLOAD
                        </button>
                    )}
                </header>

                {/* Tab Navigation */}
                <TabNavigation 
                    activeTab={activeTab} 
                    onTabChange={handleTabChange}
                    totalPayloads={totalPayloads}
                />

                {/* Tab Content */}
                <AnimatePresence mode="wait">
                    {activeTab === 'list' && (
                        <motion.div
                            key="list"
                            initial={{ opacity: 0 }}
                            animate={{ opacity: 1 }}
                            exit={{ opacity: 0 }}
                            className="flex-1 flex flex-col overflow-hidden mt-6"
                        >
                            <PayloadsListView 
                                onSwitchToCreate={() => handleTabChange('create')}
                                onSwitchToWrapper={() => handleTabChange('wrapper')}
                            />
                        </motion.div>
                    )}
                    {activeTab === 'create' && (
                        <motion.div
                            key="create"
                            initial={{ opacity: 0 }}
                            animate={{ opacity: 1 }}
                            exit={{ opacity: 0 }}
                            className="flex-1 flex flex-col overflow-hidden mt-6"
                        >
                            <CreatePayloadEmbed onComplete={() => handleTabChange('list')} />
                        </motion.div>
                    )}
                    {activeTab === 'wrapper' && (
                        <motion.div
                            key="wrapper"
                            initial={{ opacity: 0 }}
                            animate={{ opacity: 1 }}
                            exit={{ opacity: 0 }}
                            className="flex-1 flex flex-col overflow-hidden mt-6"
                        >
                            <CreateWrapperEmbed onComplete={() => handleTabChange('list')} />
                        </motion.div>
                    )}
                </AnimatePresence>
            </div>
        </div>
    );
};

export default Payloads;
